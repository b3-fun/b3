---
title: Errores
description: Manejo de errores para la API de la plataforma AnySpend
lang: es
originalPath: anyspend/api/errors.mdx
---
# Errores

La API de la plataforma AnySpend utiliza un formato de error consistente y estructurado en todos los puntos finales. Los errores siguen la convención de Stripe -- un objeto JSON con una clave `error` que contiene el tipo, código, mensaje legible por humanos y (cuando es aplicable) el parámetro que causó el error.

## Formato de respuesta de error

Cada respuesta de error tiene esta estructura:

```json
{
  "error": {
    "type": "invalid_request_error",
    "code": "missing_required_field",
    "message": "El campo 'name' es requerido.",
    "param": "name"
  }
}
```

| Campo | Tipo | Descripción |
|-------|------|-------------|
| `type` | `string` | La categoría del error. Úsalo para la lógica de manejo de errores en general. |
| `code` | `string` | Un código de error legible por máquinas. Úsalo para el manejo específico de errores. |
| `message` | `string` | Una descripción legible por humanos de lo que salió mal. Seguro para mostrar a desarrolladores (pero no a usuarios finales). |
| `param` | `string` o ausente | El parámetro de la solicitud que causó el error, si es aplicable. |

## Tipos de errores

Los tipos de errores agrupan los errores en categorías amplias. Úsalos para el manejo de errores a nivel superior.

| Tipo | Estado HTTP | Descripción |
|------|-------------|-------------|
| `invalid_request_error` | `400` | La solicitud estaba mal formada o contenía parámetros inválidos. Revisa el campo `param` para saber qué campo causó el problema. |
| `authentication_error` | `401` | La clave API falta, es inválida, ha expirado o ha sido revocada. |
| `permission_error` | `403` | La clave API es válida pero carece del nivel de permiso requerido para la operación solicitada. |
| `not_found_error` | `404` | El recurso solicitado no existe, o no pertenece a tu organización. |
| `rate_limit_error` | `429` | Has excedido el límite de tasa para tu nivel de autenticación. |
| `idempotency_error` | `409` | Una clave de idempotencia se reutilizó con un cuerpo de solicitud diferente. |
| `api_error` | `500` | Ocurrió un error interno inesperado de nuestro lado. Estos son raros y se informan automáticamente. |

## Códigos de error

Los códigos de error proporcionan identificadores específicos, legibles por máquinas, para cada condición de error.

### Errores de validación de solicitud

| Código | Tipo | HTTP | Descripción |
|------|------|------|-------------|
| `missing_required_field` | `invalid_request_error` | `400` | No se incluyó un campo requerido en el cuerpo de la solicitud. El campo `param` indica qué campo falta. |
| `invalid_field_value` | `invalid_request_error` | `400` | Se incluyó un campo pero su valor es inválido (tipo incorrecto, formato o fuera de rango). |
| `invalid_address` | `invalid_request_error` | `400` | Un campo de dirección Ethereum no es una dirección válida de `0x` + 40 caracteres hexadecimales. |
| `no_updates_provided` | `invalid_request_error` | `400` | Se envió una solicitud `PATCH` sin campos válidos para actualizar. |
| `invalid_status_transition` | `invalid_request_error` | `400` | El cambio de estado solicitado no está permitido (por ejemplo, completar una sesión ya expirada). |
| `duplicate_resource` | `invalid_request_error` | `409` | Ya existe un recurso con un campo único en conflicto. |

### Errores de autenticación y autorización

| Código | Tipo | HTTP | Descripción |
|------|------|------|-------------|
| `key_missing` | `authentication_error` | `401` | No se encontró ninguna clave API en el encabezado `Authorization` o `X-API-Key`. |
| `key_invalid` | `authentication_error` | `401` | La clave API proporcionada no coincide con ninguna clave en el sistema. |
| `key_expired` | `authentication_error` | `401` | La clave API ha pasado su marca de tiempo `expires_at`. Crea una nueva clave o extiende la expiración. |
| `key_revoked` | `authentication_error` | `401` | La clave API fue revocada explícitamente. Crea una nueva clave. |
| `insufficient_permissions` | `permission_error` | `403` | La clave API no tiene el nivel de permiso requerido para esta operación (por ejemplo, una clave de `read` intentando un `POST`). |

### Errores de recursos

| Código | Tipo | HTTP | Descripción |
|------|------|------|-------------|
| `resource_not_found` | `not_found_error` | `404` | El recurso solicitado no existe, o pertenece a una organización diferente. |

### Errores de límite de tasa e idempotencia

| Código | Tipo | HTTP | Descripción |
|------|------|------|-------------|
| `rate_limit_exceeded` | `rate_limit_error` | `429` | Demasiadas solicitudes en la ventana de tiempo actual. El mensaje de error incluye el retraso de reintento. |
| `idempotency_conflict` | `idempotency_error` | `409` | Un encabezado `Idempotency-Key` se reutilizó con un cuerpo de solicitud diferente al de la solicitud original. |

### Errores del servidor

| Código | Tipo | HTTP | Descripción |
|------|------|------|-------------|
| `internal_error` | `api_error` | `500` | Un error de servidor inesperado. Estos son automáticamente rastreados. Si esto persiste, contacta al soporte. |

## Códigos de estado HTTP

| Estado | Significado |
|--------|---------|
| `200` | Éxito -- el recurso fue recuperado o actualizado |
| `201` | Creado -- un nuevo recurso fue creado con éxito |
| `400` | Solicitud Incorrecta -- la solicitud fue inválida |
| `401` | No Autorizado -- la autenticación falló |
| `403` | Prohibido -- la clave API carece del permiso requerido |
| `404` | No Encontrado -- el recurso no existe |
| `409` | Conflicto -- conflicto de idempotencia o recurso duplicado |
| `429` | Demasiadas Solicitudes -- se excedió el límite de tasa |
| `500` | Error Interno del Servidor -- algo salió mal de nuestro lado |

## Ejemplos de respuestas de error

### Campo requerido faltante

```bash
curl -X POST https://platform-api.anyspend.com/api/v1/payment-links \
  -H "Authorization: Bearer asp_live_abc123..." \
  -H "Content-Type: application/json" \
  -d '{ "amount": "10000000" }'
```

```json
{
  "error": {
    "type": "invalid_request_error",
    "code": "missing_required_field",
    "message": "El campo 'name' es requerido.",
    "param": "name"
  }
}
```

### Dirección Ethereum inválida

```bash
curl -X POST https://platform-api.anyspend.com/api/v1/payment-links \
  -H "Authorization: Bearer asp_live_abc123..." \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test Link",
    "token_address": "not-an-address",
    "chain_id": 8453,
    "recipient_address": "0xabc123..."
  }'
```

```json
{
  "error": {
    "type": "invalid_request_error",
    "code": "invalid_address",
    "message": "El campo 'token_address' debe ser una dirección Ethereum válida (0x + 40 caracteres hexadecimales).",
    "param": "token_address"
  }
}
```

### Fallo de autenticación

```bash
curl https://platform-api.anyspend.com/api/v1/payment-links \
  -H "Authorization: Bearer asp_live_expired_key..."
```

```json
{
  "error": {
    "type": "authentication_error",
    "code": "key_expired",
    "message": "Esta clave API ha expirado."
  }
}
```

### Permisos insuficientes

```bash
# Una clave de solo lectura intentando crear un recurso
curl -X POST https://platform-api.anyspend.com/api/v1/payment-links \
  -H "Authorization: Bearer asp_live_readonly_key..." \
  -H "Content-Type: application/json" \
  -d '{ "name": "Test" }'
```

```json
{
  "error": {
    "type": "permission_error",
    "code": "insufficient_permissions",
    "message": "Esta clave API no tiene permiso de 'escritura'."
  }
}
```

### Recurso no encontrado

```bash
curl https://platform-api.anyspend.com/api/v1/payment-links/pl_nonexistent \
  -H "Authorization: Bearer asp_live_abc123..."
```

```json
{
  "error": {
    "type": "not_found_error",
    "code": "resource_not_found",
    "message": "No se encontró ningún payment_link con el id 'pl_nonexistent'."
  }
}
```

### Límite de tasa excedido

```json
{
  "error": {
    "type": "rate_limit_error",
    "code": "rate_limit_exceeded",
    "message": "Límite de tasa excedido. Reintenta después de 42 segundos."
  }
}
```

### Conflicto de idempotencia

```json
{
  "error": {
    "type": "idempotency_error",
    "code": "idempotency_conflict",
    "message": "Se utilizó una clave de idempotencia con un cuerpo de solicitud diferente."
  }
}
```

## Manejo de errores en código

### TypeScript / JavaScript

```typescript
async function createPaymentLink(data: PaymentLinkInput) {
  const response = await fetch(
    "https://platform-api.anyspend.com/api/v1/payment-links",
    {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${process.env.ANYSPEND_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify(data),
    }
  );

  const body = await response.json();

  if (!response.ok) {
    const error = body.error;

    switch (error.type) {
      case "invalid_request_error":
        // Corrige la solicitud -- revisa error.param para el campo incorrecto
        console.error(`Solicitud inválida: ${error.message} (campo: ${error.param})`);
        break;

      case "authentication_error":
        // Revisa tu clave API -- podría estar expirada o revocada
        console.error(`Fallo de autenticación: ${error.message}`);
        break;

      case "permission_error":
        // Actualiza los permisos de la clave API
        console.error(`Permisos insuficientes: ${error.message}`);
        break;

      case "rate_limit_error":
        // Retrocede y reintenta
        console.warn(`Límite de tasa: ${error.message}`);
        await sleep(5000);
        return createPaymentLink(data); // reintenta
        break;

      case "not_found_error":
        console.error(`No encontrado: ${error.message}`);
        break;

      case "idempotency_error":
        // La clave de idempotencia se reutilizó con datos diferentes
        console.error(`Conflicto de idempotencia: ${error.message}`);
        break;

      case "api_error":
        // Error del servidor -- reintenta con retroceso exponencial
        console.error(`Error del servidor: ${error.message}`);
        break;
    }

    throw new Error(`Error de API AnySpend: ${error.code} - ${error.message}`);
  }

  return body;
}
```

### Python

```python
import requests
import time

def create_payment_link(data: dict) -> dict:
    response = requests.post(
        "https://platform-api.anyspend.com/api/v1/payment-links",
        headers={
            "Authorization": f"Bearer {os.environ['ANYSPEND_API_KEY']}",
            "Content-Type": "application/json",
        },
        json=data,
    )

    body = response.json()

    if not response.ok:
        error = body["error"]
        error_type = error["type"]

        if error_type == "rate_limit_error":
            time.sleep(5)
            return create_payment_link(data)  # reintenta

        if error_type == "authentication_error":
            raise PermissionError(f"Fallo de autenticación: {error['message']}")

        if error_type == "invalid_request_error":
            raise ValueError(
                f"Solicitud incorrecta en el campo '{error.get('param', 'desconocido')}': "
                f"{error['message']}"
            )

        raise Exception(f"Error de API AnySpend: {error['code']} - {error['message']}")

    return body
```

## Mejores prácticas

<AccordionGroup>
<Accordion title="Siempre revisa primero el tipo de error">
Usa `error.type` para el control de flujo general (por ejemplo, reintenta en `rate_limit_error`, falla rápidamente en `authentication_error`). Usa `error.code` para el manejo específico dentro de un tipo.
</Accordion>

<Accordion title="Usa el campo param para construir validación de formulario">
Cuando `error.param` está presente, puedes mapearlo directamente a un campo de formulario para mostrar errores de validación en línea en tu UI.
</Accordion>

<Accordion title="Implementa lógica de reintento para errores transitorios">
`rate_limit_error` y `api_error` (500) son transitorios. Usa retroceso exponencial al reintentar:

```typescript
async function withRetry<T>(fn: () => Promise<T>, maxRetries = 3): Promise<T> {
  for (let attempt = 0; attempt <= maxRetries; attempt++) {
    try {
      return await fn();
    } catch (err: any) {
      const isRetryable =
        err.status === 429 || err.status === 500;

      if (!isRetryable || attempt === maxRetries) throw err;

      const delay = Math.min(1000 * Math.pow(2, attempt), 10000);
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
  throw new Error("Inalcanzable");
}
```
</Accordion>

<Accordion title="Nunca reintentes errores 4xx (excepto 429)">
Errores de cliente como `400`, `401`, `403`, y `404` no se resolverán al reintentar. Corrige la solicitud o las credenciales antes de reintentar.
</Accordion>

<Accordion title="Registra el objeto de error completo para depuración">
Siempre registra `error.type`, `error.code`, `error.message`, y `error.param` juntos. Esto te da una imagen completa al depurar problemas de producción.
</Accordion>
</AccordionGroup>
