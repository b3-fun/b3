---
title: Manejo de errores
description: >-
  Estados de pedidos, códigos de error y patrones para manejar fallos en
  AnySpend
lang: es
originalPath: anyspend/error-handling.mdx
---
## Ciclo de vida del estado del pedido

Cada pedido de AnySpend pasa por estos estados:

```typescript title="Estados del pedido" icon="list"
enum OrderStatus {
  // Esperando
  SCANNING_DEPOSIT_TRANSACTION = "scanning_deposit_transaction",
  WAITING_STRIPE_PAYMENT = "waiting_stripe_payment",
  EXPIRED = "expired",

  // Procesando
  SENDING_TOKEN_FROM_VAULT = "sending_token_from_vault",
  RELAY = "relay",

  // Hecho
  EXECUTED = "executed",

  // Fallido
  REFUNDING = "refunding",
  REFUNDED = "refunded",
  FAILURE = "failure",
}
```

| Estado | Qué está pasando | Acción del usuario |
|--------|-----------------|-------------|
| `scanning_deposit_transaction` | Esperando confirmación de la blockchain | Ninguna -- esperar |
| `waiting_stripe_payment` | Procesando pago con tarjeta | Puede necesitar completar 3D Secure |
| `sending_token_from_vault` | Enviando tokens para el intercambio | Ninguna -- automático |
| `relay` | Transacción entre cadenas en progreso | Ninguna -- esperar |
| `executed` | Hecho | Ninguna |
| `expired` | Pedido expiró antes de que llegara el pago | Crear un nuevo pedido |
| `refunding` | Reembolso automático en progreso | Ninguna -- esperar |
| `refunded` | Reembolso enviado | Verificar billetera para los tokens reembolsados |
| `failure` | Transacción fallida | Revisar detalles del error, reintentar |

## Códigos de error

### Errores de pago

<AccordionGroup>
<Accordion title="INSUFFICIENT_BALANCE">
El usuario no tiene suficientes tokens. Indícales que agreguen fondos o cambien a un token diferente.

```typescript
if (error.message === "INSUFFICIENT_BALANCE") {
  toast.error("Fondos insuficientes. Agrega tokens o elige otro método de pago.");
}
```
</Accordion>

<Accordion title="INVALID_TOKEN_ADDRESS">
El contrato del token no es compatible con la cadena objetivo. Muestra al usuario qué tokens están disponibles.

```typescript
if (error.message === "INVALID_TOKEN_ADDRESS") {
  toast.error("Este token no es compatible. Por favor, elige otro.");
}
```
</Accordion>

<Accordion title="MINIMUM_AMOUNT_NOT_MET">
La cantidad de la transacción está por debajo del umbral mínimo.

```typescript
if (error.message === "MINIMUM_AMOUNT_NOT_MET") {
  toast.error(`La cantidad mínima es $${minimumAmount}.`);
}
```
</Accordion>

<Accordion title="MAXIMUM_AMOUNT_EXCEEDED">
La cantidad de la transacción excede el límite. Divide en múltiples transacciones o reduce la cantidad.

```typescript
if (error.message === "MAXIMUM_AMOUNT_EXCEEDED") {
  toast.error(`La cantidad máxima es $${maximumAmount}.`);
}
```
</Accordion>
</AccordionGroup>

### Errores de red

<AccordionGroup>
<Accordion title="SLIPPAGE">
El precio se movió más allá de la tolerancia durante la ejecución. Reintenta o espera a que el mercado se estabilice.

```typescript
if (error.message === "SLIPPAGE") {
  toast.warning("El precio se movió. Reintentando...");
  retryWithHigherSlippage();
}
```
</Accordion>

<Accordion title="NETWORK_ERROR">
Problema de conexión RPC o congestión de la cadena. Reintenta después de un breve retraso.

```typescript
if (error.message === "NETWORK_ERROR") {
  toast.error("Problema de red. Verifica tu conexión e inténtalo de nuevo.");
}
```
</Accordion>

<Accordion title="QUOTE_EXPIRED">
La cotización del precio está desactualizada. Obtén una nueva.

```typescript
if (error.message === "QUOTE_EXPIRED") {
  toast.info("Cotización expirada. Obteniendo una nueva...");
  refreshQuoteAndRetry();
}
```
</Accordion>

<Accordion title="CHAIN_NOT_SUPPORTED">
La cadena solicitada no es compatible. Muestra al usuario qué cadenas están disponibles.

```typescript
if (error.message === "CHAIN_NOT_SUPPORTED") {
  toast.error("Esta cadena no es compatible.");
  showSupportedChains();
}
```
</Accordion>
</AccordionGroup>

### Errores de contrato

<AccordionGroup>
<Accordion title="CONTRACT_CALL_FAILED">
La ejecución del contrato inteligente falló. Verifica los parámetros del contrato y el estado.
</Accordion>

<Accordion title="INSUFFICIENT_GAS">
El límite de gas fue demasiado bajo. Reintenta con un límite más alto.
</Accordion>

<Accordion title="NONCE_TOO_LOW">
Conflicto de nonce de una transacción pendiente. Espera a que se confirme la tx pendiente, luego reintenta.
</Accordion>

<Accordion title="TRANSACTION_REVERTED">
El contrato se revirtió. Usualmente significa que no se cumplió una precondición (por ejemplo, venta finalizada, saldo insuficiente).
</Accordion>
</AccordionGroup>

## Patrones de manejo de errores

### Manejo de errores por componente

```tsx title="Pago con manejo de errores" icon="shield-exclamation"
import { useAnyspendCreateOrder } from "@b3dotfun/sdk/anyspend";

function PaymentComponent() {
  const [error, setError] = useState<string | null>(null);
  const [retryCount, setRetryCount] = useState(0);

  const { createOrder, isCreatingOrder } = useAnyspendCreateOrder({
    onError: (error) => {
      switch (error.message) {
        case "INSUFFICIENT_BALANCE":
          setError("Fondos insuficientes. Agrega tokens o prueba otro método de pago.");
          break;
        case "SLIPPAGE":
          if (retryCount < 3) {
            setError("El precio se movió. Reintentando...");
            setTimeout(() => {
              setRetryCount((prev) => prev + 1);
              retryPayment();
            }, 2000);
          } else {
            setError("Precio demasiado volátil ahora. Inténtalo más tarde.");
          }
          break;
        case "QUOTE_EXPIRED":
          setError("Cotización expirada. Obteniendo una nueva...");
          refreshQuote();
          break;
        default:
          setError("Pago fallido. Inténtalo de nuevo o contacta soporte.");
      }
    },
    onSuccess: () => {
      setError(null);
      setRetryCount(0);
    },
  });

  return (
    <div>
      {error && (
        <div className="error-banner">
          <span>{error}</span>
          <button onClick={() => setError(null)}>Descartar</button>
        </div>
      )}
      <button onClick={handlePayment} disabled={isCreatingOrder}>
        {isCreatingOrder ? "Procesando..." : "Pagar ahora"}
      </button>
    </div>
  );
}
```

### Monitoreo del estado del pedido

```tsx title="Seguidor de pedidos" icon="eye"
import { useAnyspendOrderAndTransactions } from "@b3dotfun/sdk/anyspend";

function OrderTracker({ orderId }: { orderId: string }) {
  const { orderAndTransactions, isLoadingOrderAndTransactions, getOrderAndTransactionsError } =
    useAnyspendOrderAndTransactions(orderId);

  if (getOrderAndTransactionsError) {
    return (
      <div>
        <p>No se pudo cargar el estado del pedido. Verifica tu conexión e inténtalo de nuevo.</p>
        <button onClick={() => window.location.reload()}>Reintentar</button>
      </div>
    );
  }

  if (!orderAndTransactions) return <div>Cargando estado del pedido...</div>;

  const { order, executeTx, refundTxs } = orderAndTransactions.data;

  switch (order.status) {
    case "scanning_deposit_transaction":
      return <p>Esperando confirmación de pago (1-2 minutos)...</p>;
    case "relay":
      return <p>Procesando transacción entre cadenas...</p>;
    case "executed":
      return (
        <div>
          <p>¡Hecho!</p>
          {executeTx && (
            <a href={`https://basescan.org/tx/${executeTx.txHash}`} target="_blank">
              Ver transacción
            </a>
          )}
        </div>
      );
    case "failure":
    case "obtain_failed":
      return (
        <div>
          <p>Transacción fallida: {order.errorDetails || "Error desconocido"}</p>
          <button onClick={() => createNewOrder()}>Intentar de nuevo</button>
        </div>
      );
    case "refunded":
      return <p>Reembolso procesado. Revisa tu billetera.</p>;
    case "expired":
      return (
        <div>
          <p>Pedido expirado antes de que llegara el pago.</p>
          <button onClick={() => createNewOrder()}>Crear nuevo pedido</button>
        </div>
      );
    default:
      return <p>Procesando... (estado: {order.status})</p>;
  }
}
```

### Límite de errores

Envuelve los componentes de AnySpend en un límite de errores para capturar fallos de renderizado:

```tsx title="Límite de errores" icon="shield"
import React, { Component, ErrorInfo } from "react";

class AnySpendErrorBoundary extends Component<
  { children: React.ReactNode },
  { hasError: boolean; error?: Error }
> {
  state = { hasError: false, error: undefined as Error | undefined };

  static getDerivedStateFromError(error: Error) {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    console.error("Error de AnySpend:", error, errorInfo);
    // Reportar a tu servicio de seguimiento de errores (Sentry, etc.)
  }

  render() {
    if (this.state.hasError) {
      return (
        <div>
          <h3>Algo salió mal</h3>
          <p>{this.state.error?.message}</p>
          <button onClick={() => this.setState({ hasError: false })}>Intentar de nuevo</button>
        </div>
      );
    }
    return this.props.children;
  }
}

// Uso
function App() {
  return (
    <AnySpendErrorBoundary>
      <AnyspendProvider>
        <YourApp />
      </AnyspendProvider>
    </AnySpendErrorBoundary>
  );
}
```

## Mensajes de error amigables para el usuario

Un ayudante que mapea códigos de error a mensajes que tus usuarios pueden entender realmente:

```tsx title="Ayudante de mensajes de error" icon="comment"
function getErrorMessage(error: Error) {
  const map: Record<string, { title: string; message: string; action?: string }> = {
    INSUFFICIENT_BALANCE: {
      title: "Saldo insuficiente",
      message: "No tienes fondos suficientes para esta transacción.",
      action: "Agrega fondos o elige otro método de pago.",
    },
    SLIPPAGE: {
      title: "Cambio de precio",
      message: "El precio se movió mientras procesábamos tu transacción.",
      action: "Reintentaremos con una cotización actualizada.",
    },
    NETWORK_ERROR: {
      title: "Problema de conexión",
      message: "No se puede alcanzar la red blockchain.",
      action: "Verifica tu conexión a internet e inténtalo de nuevo.",
    },
    QUOTE_EXPIRED: {
      title: "Cotización expirada",
      message: "La cotización del precio ya no es válida.",
      action: "Obteniendo una nueva cotización...",
    },
  };

  return map[error.message] ?? {
    title: "Transacción fallida",
    message: "Algo salió mal.",
    action: "Inténtalo de nuevo o contacta soporte.",
  };
}
```

## Consejos

- **Mantén informados a los usuarios** durante operaciones largas. Las transacciones entre cadenas pueden tardar unos minutos -- muestra progreso, no solo un spinner.
- **Reintenta errores transitorios** (deslizamiento, red, cotización expirada) con retroceso exponencial. Muchos se resuelven en el segundo intento.
- **Registra errores** con contexto (ID del pedido, dirección del usuario, marca de tiempo) para que puedas depurar problemas después del hecho.
- **Ofrece alternativas** cuando sea posible. Si la transacción entre cadenas falla, sugiere la misma cadena. Si falla cripto, sugiere una rampa de entrada fiat.

## Obtener ayuda

<CardGroup cols={2}>
<Card title="Discord" icon="discord" href="https://discord.gg/b3dotfun">
  Obtén ayuda de la comunidad y el equipo de soporte
</Card>

<Card title="GitHub" icon="github" href="https://github.com/b3-fun/b3/issues">
  Reporta errores y solicita características
</Card>
</CardGroup>

<Info>
  Al reportar problemas, incluye: mensaje/código de error, pasos para reproducir, información del navegador/dispositivo y ID del pedido si aplica.
</Info>
