---
title: "Core Concepts"
description: "Understand how AnySpend X402 works - architecture, payment flows, and security model"
---

## What is X402?

X402 is an open payment protocol that modernizes HTTP's `402 Payment Required` status code for cryptocurrency micropayments. Developed by Coinbase, it enables instant, automatic payments directly over HTTP without requiring traditional payment infrastructure.

**Key Principles:**
- **HTTP-native**: Payments happen as part of normal HTTP requests
- **Open standard**: No single-party control
- **Chain agnostic**: Works across multiple blockchains
- **Trust-minimized**: Cryptographic signatures prevent unauthorized transfers

## AnySpend's Multi-Token Extension

Standard X402 implementations only support USDC payments. **AnySpend extends X402** to support payments in any ERC-20 token while maintaining backward compatibility.

**Innovation:**
- Clients pay with **any token** they hold (ETH, DAI, WETH, etc.)
- AnySpend converts tokens to USDC automatically
- Resource servers receive USDC
- Clients remain unaware of the conversion (standard X402 protocol)

## Architecture

### Three Core Entities

<Steps>
<Step title="Client (Payer)">
The entity making payment to access a resource. Can be:
- A web application with a connected wallet
- An autonomous AI agent
- A backend service with programmatic wallet
</Step>

<Step title="Resource Server (Seller)">
HTTP service providing paywalled content or APIs:
- Premium data APIs
- AI inference services
- Computational resources
- Gated content
</Step>

<Step title="Facilitator (Payment Processor)">
Third-party service that handles payment verification and settlement:
- **AnySpend Facilitator**: `https://mainnet.anyspend.com/x402`
- Verifies cryptographic payment signatures
- Executes on-chain settlements
- Handles token swaps when needed
</Step>
</Steps>

### System Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                         Client                              │
│                    (Pays with ETH/DAI/USDC)                 │
└────────────────────┬────────────────────────────────────────┘
                     │
                     │ 1. GET /resource
                     │ 2. 402 Payment Required
                     │ 3. GET /resource + X-PAYMENT header
                     │ 4. 200 OK + data
                     │
┌────────────────────▼────────────────────────────────────────┐
│                   Resource Server                           │
│                  (Your API - Receives USDC)                 │
│                                                             │
│  ┌──────────────────────────────────────────────────┐     │
│  │        AnySpend X402 Middleware                  │     │
│  │  • Intercepts X-PREFERRED-TOKEN header           │     │
│  │  • Gets quote from facilitator                   │     │
│  │  • Returns 402 with token-specific amount        │     │
│  │  • Forwards payment to facilitator               │     │
│  └──────────────────┬───────────────────────────────┘     │
└─────────────────────┼───────────────────────────────────────┘
                      │
                      │ /verify, /settle, /quote
                      │
┌─────────────────────▼───────────────────────────────────────┐
│              AnySpend Facilitator                           │
│         https://mainnet.anyspend.com/x402                   │
│                                                             │
│  • POST /verify   - Validate signature                      │
│  • POST /settle   - Execute settlement + swap               │
│  • POST /quote    - Get token conversion rate               │
│  • GET  /supported - List supported chains/tokens           │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      │ Smart contract calls
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                    Blockchain                               │
│              (Base, Ethereum, Arbitrum, etc.)               │
│                                                             │
│  • USDC Contract (EIP-3009)                                 │
│  • ERC-20 Tokens (EIP-2612)                                 │
│  • Relay Protocol (Token Swaps)                             │
└─────────────────────────────────────────────────────────────┘
```

## Payment Flows

### Flow 1: Direct USDC Payment

When a client pays directly in USDC (no token swap needed):

<Steps>
<Step title="Client Requests Resource">
```http
GET /api/premium-data HTTP/1.1
Host: api.example.com
```
</Step>

<Step title="402 Payment Required">
Resource server responds with payment requirements:
```json
{
  "x402": "0.2",
  "requirements": [{
    "scheme": "exact",
    "network": "base-mainnet",
    "amount": "1000000",           // 1 USDC (6 decimals)
    "asset": "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",
    "recipient": "0xResourceServerWallet...",
    "timeout": 300
  }]
}
```
</Step>

<Step title="Client Signs Authorization">
Client creates EIP-3009 `transferWithAuthorization` signature:
```typescript
const signature = await signTransferWithAuthorization({
  from: clientAddress,
  to: recipientAddress,
  value: amount,
  validAfter: 0,
  validBefore: deadline,
  nonce: randomNonce()
});
```
</Step>

<Step title="Client Retries with Payment">
```http
GET /api/premium-data HTTP/1.1
Host: api.example.com
X-PAYMENT: eyJ4NDAyIjoiMC4yIiwic2NoZW1lIjoiZXhhY3QiLCJuZXR3b3JrIjoiYmFzZS1tYWlubmV0IiwicGF5bG9hZCI6eyJmcm9tIjoiMHguLi4iLCJzaWduYXR1cmUiOiIweDEyMzQuLi4ifX0=
```
</Step>

<Step title="Middleware Verifies Payment">
Resource server forwards to facilitator:
```typescript
POST https://mainnet.anyspend.com/x402/verify
{
  "x402Version": "0.2",
  "paymentHeader": "eyJ4NDA...",
  "paymentRequirements": { ... }
}

Response: { "valid": true }
```
</Step>

<Step title="Facilitator Settles Payment">
```typescript
POST https://mainnet.anyspend.com/x402/settle

// Facilitator executes on-chain:
1. receiveWithAuthorization() - Transfer USDC from client to facilitator
2. transfer() - Transfer USDC from facilitator to resource server

Response: {
  "txHash": "0xabc123...",
  "network": "base-mainnet"
}
```
</Step>

<Step title="Resource Delivered">
```http
HTTP/1.1 200 OK
X-PAYMENT-RESPONSE: eyJ0eEhhc2giOiIweGFiYzEyMy4uLiIsIm5ldHdvcmsiOiJiYXNlLW1haW5uZXQifQ==

{
  "data": "Your premium data here"
}
```
</Step>
</Steps>

**On-Chain Transactions:** 2 transactions
- Receipt: Client → Facilitator (USDC)
- Settlement: Facilitator → Resource Server (USDC)

**Fees:** 0.25% (AnySpend fee only)

---

### Flow 2: Multi-Token Payment (with Swap)

When a client pays with a token other than USDC (e.g., ETH, DAI):

<Steps>
<Step title="Client Requests with Token Preference">
```http
GET /api/premium-data HTTP/1.1
Host: api.example.com
X-PREFERRED-TOKEN: 0x4200000000000000000000000000000000000006
X-PREFERRED-NETWORK: base-mainnet
```
(WETH on Base)
</Step>

<Step title="Middleware Gets Quote">
Middleware calls facilitator for conversion rate:
```typescript
POST https://mainnet.anyspend.com/x402/quote
{
  "usdcAmount": "1000000",        // Want 1 USDC
  "paymentToken": "0x4200...",    // Client wants to pay with WETH
  "network": "base-mainnet"
}

Response: {
  "tokenAmount": "300000000000000",  // 0.0003 WETH
  "exchangeRate": "0.0003",
  "deadline": 1730000000
}
```
</Step>

<Step title="402 with Token-Specific Amount">
Resource server returns payment requirements **in WETH**:
```json
{
  "x402": "0.2",
  "requirements": [{
    "scheme": "exact",
    "network": "base-mainnet",
    "amount": "300000000000000",     // 0.0003 WETH (not USDC!)
    "asset": "0x4200...",             // WETH address
    "recipient": "0xResourceServer...",
    "timeout": 300
  }]
}
```

**Key:** Client sees a standard X402 request for WETH. No knowledge of USDC or swaps!
</Step>

<Step title="Client Signs EIP-2612 Permit">
```typescript
const signature = await signPermit({
  owner: clientAddress,
  spender: facilitatorAddress,
  value: amount,
  deadline: deadline,
  nonce: await token.nonces(clientAddress)
});
```
</Step>

<Step title="Payment with WETH Authorization">
```http
GET /api/premium-data HTTP/1.1
X-PAYMENT: eyJ4NDAyIjoiMC4yIiwic2NoZW1lIjoiZXhhY3QiLCJuZXR3b3JrIjoiYmFzZS1tYWlubmV0IiwicGF5bG9hZCI6eyJmcm9tIjoiMHguLi4iLCJzaWduYXR1cmUiOiIweDU2NzguLi4ifX0=
```
</Step>

<Step title="Facilitator Settles with Swap">
```typescript
POST https://mainnet.anyspend.com/x402/settle

// Facilitator executes:
1. permit() + transferFrom() - Get WETH from client
2. Relay Protocol swap - Convert WETH → USDC
3. transfer() - Send USDC to resource server

Response: {
  "txHash": "0xdef456...",           // Final settlement tx
  "network": "base-mainnet",
  "metadata": {
    "receiptTxHash": "0xabc...",     // WETH receipt
    "swapTxHash": "0x123..."          // WETH→USDC swap
  }
}
```
</Step>

<Step title="Resource Delivered">
```http
HTTP/1.1 200 OK
X-PAYMENT-RESPONSE: eyJ0eEhhc2giOiIweGRlZjQ1Ni4uLiJ9

{
  "data": "Your premium data here"
}
```
</Step>
</Steps>

**On-Chain Transactions:** 3+ transactions
- Receipt: Client → Facilitator (WETH)
- Swap: Relay Protocol (WETH → USDC)
- Settlement: Facilitator → Resource Server (USDC)

**Fees:** 0.35% (0.25% AnySpend + 0.10% Relay)

## Payment Schemes

### Exact Scheme

The **exact** scheme requires payment of a specific amount to a specific recipient. This is currently the only scheme supported by X402 v0.2.

**Requirements:**
```json
{
  "scheme": "exact",
  "network": "base-mainnet",
  "amount": "1000000",              // Exact amount in token's smallest unit
  "asset": "0x833589...",           // Token contract address
  "recipient": "0xReceiver...",     // Must be paid to this address
  "timeout": 300                     // Payment valid for 5 minutes
}
```

**Future Schemes:**
- **streaming**: Continuous payments over time
- **subscription**: Recurring payment authorization
- **metered**: Pay based on usage

## Signature-Based Transfers

AnySpend X402 uses **cryptographic signatures** instead of traditional token approvals for enhanced security.

### EIP-3009: transferWithAuthorization (USDC)

USDC implements `transferWithAuthorization` which allows users to authorize a transfer with a signature.

**Signature Message:**
```solidity
keccak256(abi.encode(
    TRANSFER_WITH_AUTHORIZATION_TYPEHASH,
    from,           // Payer address
    to,             // Recipient address
    value,          // Amount to transfer
    validAfter,     // 0 (valid immediately)
    validBefore,    // Deadline timestamp
    nonce           // Random bytes32 nonce
))
```

**Execution:**
```solidity
function receiveWithAuthorization(
    address from,
    address to,
    uint256 value,
    uint256 validAfter,
    uint256 validBefore,
    bytes32 nonce,
    bytes memory signature
) external;
```

**Benefits:**
- ✅ One-time use (nonce prevents replay)
- ✅ Time-limited (deadline enforcement)
- ✅ No pre-approval needed
- ✅ Gasless for payer (facilitator pays gas)

### EIP-2612: Permit (Standard ERC-20)

Most modern ERC-20 tokens implement the `permit` function for signature-based approvals.

**Signature Message:**
```typescript
{
  Permit: [
    { name: 'owner', type: 'address' },
    { name: 'spender', type: 'address' },
    { name: 'value', type: 'uint256' },
    { name: 'nonce', type: 'uint256' },
    { name: 'deadline', type: 'uint256' }
  ]
}
```

**Execution:**
```solidity
// 1. Execute permit (sets approval)
function permit(
    address owner,
    address spender,
    uint256 value,
    uint256 deadline,
    uint8 v, bytes32 r, bytes32 s
) external;

// 2. Transfer tokens
function transferFrom(
    address from,
    address to,
    uint256 amount
) external;
```

**Benefits:**
- ✅ Standard across many tokens (WETH, DAI, etc.)
- ✅ Time-limited approvals
- ✅ Sequential nonce (auto-increments)
- ✅ Widely supported

## Security Model

### Nonce-Based Replay Protection

**USDC (bytes32 nonce):**
- Each nonce can only be used once
- Client generates random bytes32 nonce
- Facilitator checks `authorizationState(from, nonce)` before settlement
- Prevents signature reuse

**ERC-2612 (uint256 nonce):**
- Sequential nonce auto-increments on-chain
- Client queries current nonce: `token.nonces(owner)`
- Invalid nonce causes transaction revert
- Prevents out-of-order or duplicate settlements

### Deadline Enforcement

All payment signatures include a deadline:
- Default: 5 minutes (300 seconds)
- Prevents stale payments
- Signatures expire automatically
- Resource servers can reject expired payments

### Exact Amount Authorization

Clients only authorize the **exact payment amount**:
- No unlimited approvals
- No risk of over-payment
- Authorization is single-use
- Resource server cannot extract more funds

### Signature Verification

Facilitator verifies signatures before settlement:

**For USDC:**
```typescript
// Reconstruct message hash
const messageHash = keccak256(
  encodePacked(
    DOMAIN_SEPARATOR,
    keccak256(encodeAbiParameters([...]))
  )
);

// Recover signer
const recoveredSigner = recoverMessageAddress({
  message: messageHash,
  signature
});

// Verify signer matches claimed payer
assert(recoveredSigner === from);
```

**For ERC-2612:**
```typescript
const recoveredSigner = recoverTypedDataAddress({
  domain: tokenDomain,
  types: permitTypes,
  primaryType: 'Permit',
  message: permitMessage,
  signature
});

assert(recoveredSigner === owner);
```

## Token Swaps via Relay Protocol

When clients pay with non-USDC tokens, AnySpend uses the [Relay Protocol](https://relay.link) for token conversion.

**Relay Features:**
- Cross-chain token swaps
- Best price routing across DEXs
- Automatic bridging when needed
- Slippage protection

**Quote Process:**
```typescript
// 1. Get quote
const quote = await relay.getQuote({
  user: clientAddress,
  originChainId: 8453,           // Base
  destinationChainId: 8453,
  originCurrency: wethAddress,   // WETH
  destinationCurrency: usdcAddress,
  amount: '300000000000000',     // 0.0003 WETH
  recipient: facilitatorAddress
});

// 2. Execute swap
const tx = await relay.execute({
  quote,
  wallet: facilitatorWallet
});

// 3. Wait for completion
const result = await relay.getStatus(tx.hash);
```

**Swap Fees:**
- Relay Protocol: ~0.10%
- Gas costs: Paid by facilitator
- Total additional cost: 0.10% on top of AnySpend's 0.25%

## Fee Structure

### Direct USDC Payments

**Fee:** 0.25% (minimum $0.01)

**Example:**
- Resource server price: 1 USDC
- Client pays: 1 USDC
- AnySpend fee: 0.0025 USDC
- Resource server receives: 0.9975 USDC

### Multi-Token Payments

**Fee:** 0.35% total
- AnySpend fee: 0.25%
- Relay swap fee: 0.10%

**Example:**
- Resource server price: 1 USDC
- Client pays: 0.0003 WETH (~1 USDC)
- Total fees: 0.0035 USDC
- Resource server receives: 0.9965 USDC

**Fee Collection:**
Fees are deducted from the settlement amount before transfer to the resource server.

## Facilitator Endpoints

### POST /verify

Validates payment signature without executing on-chain.

**Purpose:**
- Fast validation (<100ms)
- Check signature authenticity
- Verify deadline hasn't expired
- No gas costs

**Request:**
```json
{
  "x402Version": "0.2",
  "paymentHeader": "base64_encoded_payload",
  "paymentRequirements": { ... }
}
```

**Response:**
```json
{
  "valid": true
}
```

### POST /settle

Executes on-chain settlement and returns transaction hash.

**Purpose:**
- Execute payment authorization
- Swap tokens if needed
- Settle USDC to resource server
- Return transaction proof

**Response:**
```json
{
  "txHash": "0xabc123...",
  "network": "base-mainnet",
  "metadata": {
    "receiptTxHash": "0x...",
    "swapTxHash": "0x..."
  }
}
```

### POST /quote

Gets conversion rate for non-USDC tokens (AnySpend extension).

**Request:**
```json
{
  "usdcAmount": "1000000",        // Want 1 USDC
  "paymentToken": "0x4200...",    // Pay with WETH
  "network": "base-mainnet"
}
```

**Response:**
```json
{
  "tokenAmount": "300000000000000",  // 0.0003 WETH
  "exchangeRate": "0.0003",
  "deadline": 1730000000,
  "quote": {
    "srcAmount": "300000000000000",
    "dstAmount": "1000000",
    "fees": {
      "relayFeeBps": 10,
      "anyspendFeeBps": 25,
      "totalFeeBps": 35
    }
  }
}
```

### GET /supported

Lists supported (scheme, network) pairs.

**Response:**
```json
{
  "schemes": [{
    "scheme": "exact",
    "networks": [
      "base-mainnet",
      "ethereum-mainnet",
      "arbitrum-mainnet",
      "optimism-mainnet",
      "polygon-mainnet"
    ]
  }]
}
```

## Best Practices

<AccordionGroup>
<Accordion title="Always Verify Before Settling">
Call `/verify` endpoint before `/settle` to catch signature errors early without wasting gas.

```typescript
// 1. Verify first (fast, no gas)
const verification = await facilitator.verify(payment);
if (!verification.valid) {
  return res.status(402).json({ error: 'Invalid payment' });
}

// 2. Then settle (on-chain, costs gas)
const settlement = await facilitator.settle(payment);
```
</Accordion>

<Accordion title="Handle Token Swaps Transparently">
Clients should never need to know about token swaps. The middleware handles quote generation and token conversion automatically.

```typescript
// Client sees:
requirements: {
  amount: "300000000000000",  // WETH amount
  asset: "0x4200..."          // WETH address
}

// Resource server receives:
settlement: {
  amount: "1000000",          // USDC amount
  asset: "0x833589..."        // USDC address
}
```
</Accordion>

<Accordion title="Set Reasonable Deadlines">
Default 5-minute deadline balances security and user experience:
- Too short: Users can't complete payment flow
- Too long: Increased signature replay risk

```typescript
const deadline = Math.floor(Date.now() / 1000) + 300; // 5 minutes
```
</Accordion>

<Accordion title="Cache Quotes for Better UX">
Quote prices for 30-60 seconds to avoid repeatedly calling the facilitator:

```typescript
const quoteCache = new Map();

function getQuote(token, amount) {
  const key = `${token}:${amount}`;
  const cached = quoteCache.get(key);

  if (cached && cached.timestamp > Date.now() - 30000) {
    return cached.quote;  // Use cached quote if < 30s old
  }

  const quote = await facilitator.getQuote(...);
  quoteCache.set(key, { quote, timestamp: Date.now() });
  return quote;
}
```
</Accordion>
</AccordionGroup>

## What's Next?

<CardGroup cols={2}>
<Card title="Network Support" icon="globe" href="/anyspend/x402-network-support">
  See supported chains, tokens, and contract addresses
</Card>

<Card title="Quickstart for Buyers" icon="wallet" href="/anyspend/x402-quickstart-buyers">
  Start paying for services with any token
</Card>
</CardGroup>

## Further Reading

- **X402 Protocol**: [x402.org](https://x402.org)
- **Coinbase CDP X402**: [docs.cdp.coinbase.com/x402](https://docs.cdp.coinbase.com/x402)
- **EIP-2612**: [eips.ethereum.org/EIPS/eip-2612](https://eips.ethereum.org/EIPS/eip-2612)
- **EIP-3009**: [eips.ethereum.org/EIPS/eip-3009](https://eips.ethereum.org/EIPS/eip-3009)
- **Relay Protocol**: [docs.relay.link](https://docs.relay.link)
