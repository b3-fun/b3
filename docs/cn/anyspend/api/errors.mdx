---
title: 错误
description: AnySpend 平台 API 的错误处理
lang: cn
originalPath: anyspend/api/errors.mdx
---
# 错误

AnySpend 平台 API 在所有端点上使用一致、结构化的错误格式。错误遵循 Stripe 惯例 -- 一个带有 `error` 键的 JSON 对象，包含类型、代码、人类可读的消息，以及（如适用）导致错误的参数。

## 错误响应格式

每个错误响应都具有此形状：

```json
{
  "error": {
    "type": "invalid_request_error",
    "code": "missing_required_field",
    "message": "The 'name' field is required.",
    "param": "name"
  }
}
```

| 字段 | 类型 | 描述 |
|-------|------|-------------|
| `type` | `string` | 错误的类别。用于广泛的错误处理逻辑。 |
| `code` | `string` | 机器可读的错误代码。用于特定的错误处理。 |
| `message` | `string` | 关于出错原因的人类可读描述。对开发者（但不是最终用户）安全显示。 |
| `param` | `string` 或不存在 | 导致错误的请求参数（如果适用）。 |

## 错误类型

错误类型将错误分为广泛的类别。用于顶级错误处理。

| 类型 | HTTP 状态 | 描述 |
|------|-------------|-------------|
| `invalid_request_error` | `400` | 请求格式不正确或包含无效参数。检查 `param` 字段了解哪个字段导致了问题。 |
| `authentication_error` | `401` | API 密钥缺失、无效、过期或已撤销。 |
| `permission_error` | `403` | API 密钥有效但缺乏请求操作所需的权限级别。 |
| `not_found_error` | `404` | 请求的资源不存在，或不属于您的组织。 |
| `rate_limit_error` | `429` | 您已超出认证层的速率限制。 |
| `idempotency_error` | `409` | 重用了具有不同请求体的幂等性密钥。 |
| `api_error` | `500` | 我们这边发生了意外的内部错误。这些很少见，并且会自动报告。 |

## 错误代码

错误代码为每个错误条件提供特定的、机器可读的标识符。

### 请求验证错误

| 代码 | 类型 | HTTP | 描述 |
|------|------|------|-------------|
| `missing_required_field` | `invalid_request_error` | `400` | 请求体中缺少必需的字段。`param` 字段指示缺少哪个字段。 |
| `invalid_field_value` | `invalid_request_error` | `400` | 包含了字段，但其值无效（类型、格式或范围错误）。 |
| `invalid_address` | `invalid_request_error` | `400` | 一个以太坊地址字段不是有效的 `0x` + 40 十六进制字符地址。 |
| `no_updates_provided` | `invalid_request_error` | `400` | 发送了一个 `PATCH` 请求，但没有有效字段进行更新。 |
| `invalid_status_transition` | `invalid_request_error` | `400` | 请求的状态更改不允许（例如，完成一个已过期的会话）。 |
| `duplicate_resource` | `invalid_request_error` | `409` | 已存在具有冲突唯一字段的资源。 |

### 认证和授权错误

| 代码 | 类型 | HTTP | 描述 |
|------|------|------|-------------|
| `key_missing` | `authentication_error` | `401` | 在 `Authorization` 或 `X-API-Key` 头中未找到 API 密钥。 |
| `key_invalid` | `authentication_error` | `401` | 提供的 API 密钥与系统中的任何密钥都不匹配。 |
| `key_expired` | `authentication_error` | `401` | API 密钥已超过其 `expires_at` 时间戳。创建新密钥或延长过期时间。 |
| `key_revoked` | `authentication_error` | `401` | API 密钥被明确撤销。创建新密钥。 |
| `insufficient_permissions` | `permission_error` | `403` | API 密钥没有此操作所需的权限级别（例如，尝试使用 `read` 密钥进行 `POST`）。 |

### 资源错误

| 代码 | 类型 | HTTP | 描述 |
|------|------|------|-------------|
| `resource_not_found` | `not_found_error` | `404` | 请求的资源不存在，或属于不同的组织。 |

### 速率限制和幂等性错误

| 代码 | 类型 | HTTP | 描述 |
|------|------|------|-------------|
| `rate_limit_exceeded` | `rate_limit_error` | `429` | 当前时间窗口内请求过多。错误消息包括重试延迟。 |
| `idempotency_conflict` | `idempotency_error` | `409` | 重用了 `Idempotency-Key` 头，但与原始请求的请求体不同。 |

### 服务器错误

| 代码 | 类型 | HTTP | 描述 |
|------|------|------|-------------|
| `internal_error` | `api_error` | `500` | 发生了意外的服务器错误。这些错误会自动跟踪。如果持续存在，请联系支持。 |

## HTTP 状态代码

| 状态 | 含义 |
|--------|---------|
| `200` | 成功 -- 资源已检索或更新 |
| `201` | 已创建 -- 成功创建了新资源 |
| `400` | 错误请求 -- 请求无效 |
| `401` | 未授权 -- 认证失败 |
| `403` | 禁止 -- API 密钥缺乏所需权限 |
| `404` | 未找到 -- 资源不存在 |
| `409` | 冲突 -- 幂等性冲突或重复资源 |
| `429` | 请求过多 -- 超出速率限制 |
| `500` | 内部服务器错误 -- 我们这边出了问题 |

## 示例错误响应

### 缺少必需字段

```bash
curl -X POST https://platform-api.anyspend.com/api/v1/payment-links \
  -H "Authorization: Bearer asp_live_abc123..." \
  -H "Content-Type: application/json" \
  -d '{ "amount": "10000000" }'
```

```json
{
  "error": {
    "type": "invalid_request_error",
    "code": "missing_required_field",
    "message": "The 'name' field is required.",
    "param": "name"
  }
}
```

### 无效的以太坊地址

```bash
curl -X POST https://platform-api.anyspend.com/api/v1/payment-links \
  -H "Authorization: Bearer asp_live_abc123..." \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test Link",
    "token_address": "not-an-address",
    "chain_id": 8453,
    "recipient_address": "0xabc123..."
  }'
```

```json
{
  "error": {
    "type": "invalid_request_error",
    "code": "invalid_address",
    "message": "The 'token_address' field must be a valid Ethereum address (0x + 40 hex characters).",
    "param": "token_address"
  }
}
```

### 认证失败

```bash
curl https://platform-api.anyspend.com/api/v1/payment-links \
  -H "Authorization: Bearer asp_live_expired_key..."
```

```json
{
  "error": {
    "type": "authentication_error",
    "code": "key_expired",
    "message": "This API key has expired."
  }
}
```

### 权限不足

```bash
# 尝试创建资源的只读密钥
curl -X POST https://platform-api.anyspend.com/api/v1/payment-links \
  -H "Authorization: Bearer asp_live_readonly_key..." \
  -H "Content-Type: application/json" \
  -d '{ "name": "Test" }'
```

```json
{
  "error": {
    "type": "permission_error",
    "code": "insufficient_permissions",
    "message": "This API key does not have 'write' permission."
  }
}
```

### 资源未找到

```bash
curl https://platform-api.anyspend.com/api/v1/payment-links/pl_nonexistent \
  -H "Authorization: Bearer asp_live_abc123..."
```

```json
{
  "error": {
    "type": "not_found_error",
    "code": "resource_not_found",
    "message": "No payment_link found with id 'pl_nonexistent'."
  }
}
```

### 超出速率限制

```json
{
  "error": {
    "type": "rate_limit_error",
    "code": "rate_limit_exceeded",
    "message": "Rate limit exceeded. Retry after 42 seconds."
  }
}
```

### 幂等性冲突

```json
{
  "error": {
    "type": "idempotency_error",
    "code": "idempotency_conflict",
    "message": "An idempotency key was used with a different request body."
  }
}
```

## 在代码中处理错误

### TypeScript / JavaScript

```typescript
async function createPaymentLink(data: PaymentLinkInput) {
  const response = await fetch(
    "https://platform-api.anyspend.com/api/v1/payment-links",
    {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${process.env.ANYSPEND_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify(data),
    }
  );

  const body = await response.json();

  if (!response.ok) {
    const error = body.error;

    switch (error.type) {
      case "invalid_request_error":
        // 修复请求 -- 检查 error.param 了解错误字段
        console.error(`Invalid request: ${error.message} (field: ${error.param})`);
        break;

      case "authentication_error":
        // 检查您的 API 密钥 -- 它可能已过期或被撤销
        console.error(`Auth failed: ${error.message}`);
        break;

      case "permission_error":
        // 升级 API 密钥权限
        console.error(`Insufficient permissions: ${error.message}`);
        break;

      case "rate_limit_error":
        // 退避并重试
        console.warn(`Rate limited: ${error.message}`);
        await sleep(5000);
        return createPaymentLink(data); // 重试
        break;

      case "not_found_error":
        console.error(`Not found: ${error.message}`);
        break;

      case "idempotency_error":
        // 使用了具有不同数据的幂等性密钥
        console.error(`Idempotency conflict: ${error.message}`);
        break;

      case "api_error":
        // 服务器错误 -- 使用指数退避重试
        console.error(`Server error: ${error.message}`);
        break;
    }

    throw new Error(`AnySpend API error: ${error.code} - ${error.message}`);
  }

  return body;
}
```

### Python

```python
import requests
import time

def create_payment_link(data: dict) -> dict:
    response = requests.post(
        "https://platform-api.anyspend.com/api/v1/payment-links",
        headers={
            "Authorization": f"Bearer {os.environ['ANYSPEND_API_KEY']}",
            "Content-Type": "application/json",
        },
        json=data,
    )

    body = response.json()

    if not response.ok:
        error = body["error"]
        error_type = error["type"]

        if error_type == "rate_limit_error":
            time.sleep(5)
            return create_payment_link(data)  # 重试

        if error_type == "authentication_error":
            raise PermissionError(f"Auth failed: {error['message']}")

        if error_type == "invalid_request_error":
            raise ValueError(
                f"Bad request on field '{error.get('param', 'unknown')}': "
                f"{error['message']}"
            )

        raise Exception(f"AnySpend API error: {error['code']} - {error['message']}")

    return body
```

## 最佳实践

<AccordionGroup>
<Accordion title="始终首先检查错误类型">
使用 `error.type` 进行广泛的控制流（例如，对 `rate_limit_error` 重试，对 `authentication_error` 快速失败）。使用 `error.code` 在类型内进行具体处理。
</Accordion>

<Accordion title="使用 param 字段构建表单验证">
当 `error.param` 存在时，您可以将其直接映射到表单字段，以在您的 UI 中显示内联验证错误。
</Accordion>

<Accordion title="为瞬态错误实现重试逻辑">
`rate_limit_error` 和 `api_error`（500）是瞬态的。重试时使用指数退避：

```typescript
async function withRetry<T>(fn: () => Promise<T>, maxRetries = 3): Promise<T> {
  for (let attempt = 0; attempt <= maxRetries; attempt++) {
    try {
      return await fn();
    } catch (err: any) {
      const isRetryable =
        err.status === 429 || err.status === 500;

      if (!isRetryable || attempt === maxRetries) throw err;

      const delay = Math.min(1000 * Math.pow(2, attempt), 10000);
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
  throw new Error("Unreachable");
}
```
</Accordion>

<Accordion title="永远不要重试 4xx 错误（除了 429）">
客户端错误，如 `400`、`401`、`403` 和 `404`，重试不会解决问题。在重试之前修复请求或凭据。
</Accordion>

<Accordion title="为调试记录完整的错误对象">
始终记录 `error.type`、`error.code`、`error.message` 和 `error.param`。这在调试生产问题时为您提供完整的画面。
</Accordion>
</AccordionGroup>
