---
title: 结账会话
description: 服务器端结算会话管理，用于程序化支付流程
lang: cn
originalPath: anyspend/api/checkout-sessions-api.mdx
---
结账会话代表一个单独的支付尝试。您可以在服务器端创建会话，为每个客户生成唯一的结账 URL，预填支付详情，并使用您自己的参考 ID 跟踪转化。

<Info>
  结账会话默认在 30 分钟后过期。使用 `expires_in` 参数自定义过期时间窗口（最短 5 分钟，最长 24 小时）。
</Info>

## 结账会话对象

<ResponseField name="id" type="string">
  结账会话的唯一标识符（例如，`cs_abc123`）。
</ResponseField>

<ResponseField name="url" type="string">
  重定向客户的结账 URL。
</ResponseField>

<ResponseField name="status" type="string">
  会话的当前状态。其中之一：`open`、`processing`、`completed`、`expired`、`failed`。
</ResponseField>

<ResponseField name="payment_link_id" type="string | null">
  如果会话是从支付链接创建的，则为关联的支付链接 ID。
</ResponseField>

<ResponseField name="product_id" type="string | null">
  关联的产品 ID。
</ResponseField>

<ResponseField name="token_address" type="string">
  要接收的代币的合约地址。
</ResponseField>

<ResponseField name="chain_id" type="number">
  您希望接收支付的链 ID。
</ResponseField>

<ResponseField name="recipient_address" type="string">
  接收支付的钱包地址。
</ResponseField>

<ResponseField name="amount" type="string">
  以代币的最小单位表示的支付金额。
</ResponseField>

<ResponseField name="amount_usd" type="string | null">
  会话创建时的 USD 等值金额。
</ResponseField>

<ResponseField name="success_url" type="string | null">
  支付成功后客户被重定向的 URL。支持模板变量。
</ResponseField>

<ResponseField name="cancel_url" type="string | null">
  如果客户取消，则重定向的 URL。
</ResponseField>

<ResponseField name="client_reference_id" type="string | null">
  此会话的您的内部参考 ID。
</ResponseField>

<ResponseField name="metadata" type="object | null">
  通过 webhooks 和交易传递的任意键值对。
</ResponseField>

<ResponseField name="customer_email" type="string | null">
  客户的电子邮件地址。休息时加密，在 webhook 负载中包含。
</ResponseField>

<ResponseField name="customer_name" type="string | null">
  客户的姓名。休息时加密，在 webhook 负载中包含。
</ResponseField>

<ResponseField name="payer_address" type="string | null">
  付款人的钱包地址（连接后填充）。
</ResponseField>

<ResponseField name="tx_hash" type="string | null">
  链上交易哈希（提交后填充）。
</ResponseField>

<ResponseField name="customer_id" type="string | null">
  关联的客户 ID（支付后填充）。
</ResponseField>

<ResponseField name="form_data" type="object | null">
  客户提交的自定义表单数据。
</ResponseField>

<ResponseField name="shipping_address" type="object | null">
  客户提供的送货地址。
</ResponseField>

<ResponseField name="utm_source" type="string | null">
  UTM 来源参数，用于归因。
</ResponseField>

<ResponseField name="utm_medium" type="string | null">
  UTM 媒介参数，用于归因。
</ResponseField>

<ResponseField name="utm_campaign" type="string | null">
  UTM 活动参数，用于归因。
</ResponseField>

<ResponseField name="expires_at" type="string">
  ISO 8601 过期时间戳。
</ResponseField>

<ResponseField name="created_at" type="string">
  ISO 8601 创建时间戳。
</ResponseField>

<ResponseField name="completed_at" type="string | null">
  ISO 8601 完成时间戳。
</ResponseField>

### 会话状态

| 状态 | 描述 |
|--------|-------------|
| `open` | 会话处于活动状态，等待客户支付。 |
| `processing` | 客户已启动支付；交易正在链上处理。 |
| `completed` | 支付已确认并由收款人收到。 |
| `expired` | 客户完成支付前会话已过期。 |
| `failed` | 由于链上错误或超时，支付失败。 |

### URL 模板变量

`success_url` 和 `cancel_url` 字段支持模板变量，当客户被重定向时，这些变量会被实际值替换：

| 变量 | 描述 | 示例 |
|----------|-------------|---------|
| `{SESSION_ID}` | 结账会话 ID | `cs_abc123` |

<Tip>
  使用模板变量在重定向后在您的服务器上查找会话详情：
  `https://example.com/success?session_id={SESSION_ID}`
</Tip>

---

## 列出结账会话

检索结账会话的分页列表。

<ParamField query="status" type="string">
  按会话状态过滤：`open`、`processing`、`completed`、`expired`、`failed`。
</ParamField>

<ParamField query="payment_link_id" type="string">
  按支付链接 ID 过滤。
</ParamField>

<ParamField query="page" type="number" default={1}>
  分页的页码。
</ParamField>

<ParamField query="limit" type="number" default={20}>
  每页的结果数（最大 100）。
</ParamField>

<CodeGroup>
```bash cURL
curl -X GET "https://platform-api.anyspend.com/api/v1/checkout-sessions?status=completed&page=1&limit=20" \
  -H "Authorization: Bearer asp_xxx"
```

```typescript SDK
import { AnySpend } from "@b3dotfun/sdk";

const anyspend = new AnySpend(process.env.ANYSPEND_API_KEY!);

const { data, pagination } = await anyspend.checkoutSessions.list({
  status: "completed",
  page: 1,
  limit: 20,
});
```
</CodeGroup>

<Tabs>
  <Tab title="Response">
    ```json
    {
      "data": [
        {
          "id": "cs_abc123",
          "url": "https://pay.anyspend.com/s/cs_abc123",
          "status": "completed",
          "payment_link_id": "pl_abc123",
          "product_id": null,
          "token_address": "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",
          "chain_id": 1,
          "recipient_address": "0x1234567890abcdef1234567890abcdef12345678",
          "amount": "50000000",
          "amount_usd": "50.00",
          "success_url": "https://example.com/success?session_id=cs_abc123",
          "cancel_url": "https://example.com/cancel",
          "client_reference_id": "order_12345",
          "metadata": {
            "order_id": "12345"
          },
          "payer_address": "0xaabb1234ccdd5678eeff9900aabb1234ccdd5678",
          "tx_hash": "0x9f8e7d6c5b4a3f2e1d0c9b8a7f6e5d4c3b2a1f0e",
          "customer_id": "cust_abc123",
          "form_data": null,
          "shipping_address": null,
          "utm_source": "twitter",
          "utm_medium": "social",
          "utm_campaign": "launch_feb_2026",
          "expires_at": "2026-02-25T08:45:00Z",
          "created_at": "2026-02-25T08:15:00Z",
          "completed_at": "2026-02-25T08:16:30Z"
        }
      ],
      "pagination": {
        "page": 1,
        "limit": 20,
        "total": 340,
        "total_pages": 17,
        "has_more": true
      }
    }
    ```
  </Tab>
</Tabs>

---

## 创建结账会话

使用唯一的支付 URL 在服务器端创建结账会话。在您从后端控制结账流程的程序化集成中使用此方法。

<ParamField body="payment_link_id" type="string">
  从现有支付链接创建会话。这继承了链接的配置。`payment_link_id` 或手动字段（`token_address`、`chain_id`、`recipient_address`、`amount`）是必需的。
</ParamField>

<ParamField body="token_address" type="string">
  要接收的代币的合约地址。如果未提供 `payment_link_id`，则此项为必需。
</ParamField>

<ParamField body="chain_id" type="number">
  您希望接收支付的链 ID。如果未提供 `payment_link_id`，则此项为必需。
</ParamField>

<ParamField body="recipient_address" type="string">
  接收支付的钱包地址。如果未提供 `payment_link_id`，则此项为必需。
</ParamField>

<ParamField body="amount" type="string">
  以代币的最小单位表示的支付金额。如果未提供 `payment_link_id`，则此项为必需。
</ParamField>

<ParamField body="product_id" type="string">
  将会话与产品关联。
</ParamField>

<ParamField body="success_url" type="string">
  支付成功后重定向客户的 URL。支持 `{SESSION_ID}` 模板变量。
</ParamField>

<ParamField body="cancel_url" type="string">
  如果客户取消，则重定向的 URL。
</ParamField>

<ParamField body="client_reference_id" type="string">
  您的内部参考 ID（例如，订单 ID）。最多 200 个字符。
</ParamField>

<ParamField body="metadata" type="object">
  通过 webhooks 和结果交易传递的任意键值对。最多 50 个键，500 个字符值。
</ParamField>

<ParamField body="customer_email" type="string">
  客户电子邮件地址。休息时加密，并包含在 webhook 负载中，用于订单履行。
</ParamField>

<ParamField body="customer_name" type="string">
  客户姓名。休息时加密，并包含在 webhook 负载中，用于订单履行。
</ParamField>

<ParamField body="expires_in" type="number" default={1800}>
  会话过期时间（秒）。最小 300（5 分钟），最大 86400（24 小时）。默认：1800（30 分钟）。
</ParamField>

<ParamField body="utm_source" type="string">
  UTM 来源，用于归因跟踪。
</ParamField>

<ParamField body="utm_medium" type="string">
  UTM 媒介，用于归因跟踪。
</ParamField>

<ParamField body="utm_campaign" type="string">
  UTM 活动，用于归因跟踪。
</ParamField>

<CodeGroup>
```bash cURL
# 从支付链接创建
curl -X POST "https://platform-api.anyspend.com/api/v1/checkout-sessions" \
  -H "Authorization: Bearer asp_xxx" \
  -H "Content-Type: application/json" \
  -d '{
    "payment_link_id": "pl_abc123",
    "success_url": "https://example.com/success?session_id={SESSION_ID}",
    "cancel_url": "https://example.com/cancel",
    "client_reference_id": "order_12345",
    "metadata": {
      "order_id": "12345"
    },
    "customer_email": "alice@example.com",
    "customer_name": "Alice Smith",
    "expires_in": 3600
  }'

# 使用手动配置创建
curl -X POST "https://platform-api.anyspend.com/api/v1/checkout-sessions" \
  -H "Authorization: Bearer asp_xxx" \
  -H "Content-Type: application/json" \
  -d '{
    "token_address": "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",
    "chain_id": 1,
    "recipient_address": "0x1234567890abcdef1234567890abcdef12345678",
    "amount": "25000000",
    "success_url": "https://example.com/success?session_id={SESSION_ID}",
    "cancel_url": "https://example.com/cancel",
    "client_reference_id": "inv_67890",
    "utm_source": "email",
    "utm_medium": "newsletter",
    "utm_campaign": "february_promo"
  }'
```

```typescript SDK
// 从支付链接创建
const session = await anyspend.checkoutSessions.create({
  paymentLinkId: "pl_abc123",
  successUrl: "https://example.com/success?session_id={SESSION_ID}",
  cancelUrl: "https://example.com/cancel",
  clientReferenceId: "order_12345",
  metadata: {
    order_id: "12345",
    user_email: "alice@example.com",
  },
  expiresIn: 3600,
});

// 重定向客户支付
console.log(session.url);
// => "https://pay.anyspend.com/s/cs_newSession123"

// 使用手动配置创建
const manualSession = await anyspend.checkoutSessions.create({
  tokenAddress: "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",
  chainId: 1,
  recipientAddress: "0x1234567890abcdef1234567890abcdef12345678",
  amount: "25000000",
  successUrl: "https://example.com/success?session_id={SESSION_ID}",
  cancelUrl: "https://example.com/cancel",
  clientReferenceId: "inv_67890",
});
```
</CodeGroup>

<Tabs>
  <Tab title="Response">
    ```json
    {
      "id": "cs_newSession123",
      "url": "https://pay.anyspend.com/s/cs_newSession123",
      "status": "open",
      "payment_link_id": "pl_abc123",
      "product_id": null,
      "token_address": "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",
      "chain_id": 1,
      "recipient_address": "0x1234567890abcdef1234567890abcdef12345678",
      "amount": "50000000",
      "amount_usd": "50.00",
      "success_url": "https://example.com/success?session_id={SESSION_ID}",
      "cancel_url": "https://example.com/cancel",
      "client_reference_id": "order_12345",
      "metadata": {
        "order_id": "12345",
        "user_email": "alice@example.com"
      },
      "payer_address": null,
      "tx_hash": null,
      "customer_id": null,
      "form_data": null,
      "shipping_address": null,
      "utm_source": null,
      "utm_medium": null,
      "utm_campaign": null,
      "expires_at": "2026-02-27T11:30:00Z",
      "created_at": "2026-02-27T10:30:00Z",
      "completed_at": null
    }
    ```
  </Tab>
</Tabs>

---

## 检索结账会话

<ParamField path="id" type="string" required>
  结账会话 ID（例如，`cs_abc123`）。
</ParamField>

<Tip>
  使用此端点在您的 `success_url` 处理程序中验证支付状态并在客户被重定向回您的网站后检索交易详情。
</Tip>

<CodeGroup>
```bash cURL
curl -X GET "https://platform-api.anyspend.com/api/v1/checkout-sessions/cs_abc123" \
  -H "Authorization: Bearer asp_xxx"
```

```typescript SDK
const session = await anyspend.checkoutSessions.retrieve("cs_abc123");

if (session.status === "completed") {
  // 支付成功
  console.log("交易哈希:", session.tx_hash);
  console.log("付款人:", session.payer_address);
}
```
</CodeGroup>

<Tabs>
  <Tab title="Response">
    返回完整的[结账会话对象](#the-checkout-session-object)。
  </Tab>
</Tabs>

---

## 使结账会话过期

手动使一个开放的结账会话过期。当底层订单被取消或不再需要支付时，这很有用。

<ParamField path="id" type="string" required>
  结账会话 ID。
</ParamField>

<Warning>
  只有 `status: "open"` 的会话可以过期。
