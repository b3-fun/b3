---
title: 买家快速入门
description: 使用 AnySpend x402 客户端 SDK 用任何代币支付付费墙 API 和服务
lang: cn
originalPath: anyspend/x402-quickstart-buyers.mdx
---
## 概览

本指南展示了如何使用 **AnySpend x402 客户端 SDK** 使用您持有的任何加密货币支付需要付费的资源。SDK 自动处理整个支付流程，包括签名生成和重试逻辑。

x402 的美妙之处在于，您可以使用同一个客户端支付**任何启用了 x402 的服务**，而不仅仅是使用 AnySpend 的服务。

## 先决条件

在开始之前，请确保您具备：

- **Node.js 18+** 或兼容的 JavaScript 运行时
- **一个加密钱包**，里面有一些代币（ETH、USDC、DAI 等）
- **一个钱包库**，如 [viem](https://viem.sh) 或 [ethers.js](https://docs.ethers.org)
- **访问一个启用了 x402 的服务**（如一个需要付费的 API）

## 安装

安装 x402 客户端 SDK：

<CodeGroup>
```bash npm
npm install anyspend-x402-client viem
```

```bash yarn
yarn add anyspend-x402-client viem
```

```bash pnpm
pnpm add anyspend-x402-client viem
```
</CodeGroup>

SDK 使用 [viem](https://viem.sh) 进行钱包操作和签名生成。

## 基本用法

### 1. 创建一个钱包客户端

首先，使用 viem 设置您的钱包客户端：

```typescript
import { createWalletClient, custom } from 'viem';
import { base } from 'viem/chains';

// 对于带有 MetaMask 或其他钱包扩展的浏览器
const walletClient = createWalletClient({
  chain: base,
  transport: custom(window.ethereum)
});

// 获取用户的地址
const [address] = await walletClient.getAddresses();
```

### 2. 初始化 x402 客户端

创建 x402 客户端的实例：

```typescript
import { X402Client } from 'anyspend-x402-client';

const x402Client = new X402Client({
  walletClient,           // 您的 viem 钱包客户端
  preferredToken: '0x...', // 可选：默认支付代币
  autoRetry: true          // 自动处理 402 响应（默认：true）
});
```

### 3. 发起付费请求

使用客户端访问需要付费的资源：

```typescript
try {
  const response = await x402Client.request(
    'https://api.example.com/premium-data',
    {
      method: 'GET',
    }
  );

  console.log('数据：', response.data);
  console.log('支付交易 TX：', response.paymentResponse?.txHash);
} catch (error) {
  console.error('支付失败：', error);
}
```

**发生了什么：**

1. 客户端发起初始请求
2. API 返回 `402 Payment Required` 并提供支付详情
3. X402Client 自动签署支付授权
4. 客户端带着支付重试请求
5. API 验证并结算支付
6. 客户端接收到请求的数据

## 高级用法

### 指定支付代币

有两种方式指定您想要支付的代币：

#### 选项 1：使用 X402Client

通过设置 `preferredToken` 用特定代币支付：

```typescript
const response = await x402Client.request(
  'https://ai-agent-api.com/inference',
  {
    method: 'POST',
    body: { prompt: '生成一张猫的图片' },
    preferredToken: '0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb' // Base 上的 DAI
  }
);
```

#### 选项 2：使用 wrapFetchWithPayment（高级）

为了更多控制权，使用更低级别的 `wrapFetchWithPayment` 函数：

```typescript
import { wrapFetchWithPayment } from 'anyspend-x402-client';

const tokenAddress = '0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb'; // Base 上的 DAI
const selectedChain = 8453; // Base

const paymentPreferences = {
  preferredToken: tokenAddress,
  preferredNetwork: 'base' as const, // 或使用 getNetworkName(selectedChain)
};

console.log(`💡 使用首选代币：${tokenAddress} 在 base 上`);

// 用自动支付处理包装 fetch
const fetchWithPayment = wrapFetchWithPayment(
  fetch,
  walletClient,
  '1000000', // 最大支付值（1 USDC 的 6 位小数）
  undefined, // 使用默认支付要求选择器
  undefined, // 使用默认配置
  paymentPreferences, // 指定您的首选代币和网络
);

// 像普通 fetch 一样使用包装后的 fetch
const response = await fetchWithPayment('https://api.example.com/premium-data');
const data = await response.json();
```

**`wrapFetchWithPayment` 的好处：**
- 可以与任何现有的基于 `fetch` 的代码一起工作
- 更细粒度的支付行为控制
- 可以指定最大支付值
- 自定义支付要求选择器
- 支持多网络签名者

如果资源服务器支持 AnySpend 中间件，您将以首选代币的等价金额支付，而不是 USDC。

### 带有正文的 POST 请求

发起需要支付的 POST 请求：

```typescript
const response = await x402Client.request(
  'https://api.example.com/compute',
  {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: {
      model: 'gpt-4',
      messages: [{ role: 'user', content: '你好！' }]
    }
  }
);
```

### 手动支付流程

为了更多控制权，手动处理支付流程：

```typescript
// 1. 发起初始请求
const initialResponse = await fetch('https://api.example.com/premium-data');

if (initialResponse.status === 402) {
  // 2. 解析支付要求
  const paymentRequired = await initialResponse.json();
  const requirements = paymentRequired.requirements[0];

  console.log('需要支付：', {
    amount: requirements.amount,
    token: requirements.asset,
    recipient: requirements.recipient
  });

  // 3. 签署支付授权
  const paymentHeader = await x402Client.signPayment(requirements);

  // 4. 带着支付重试
  const paidResponse = await fetch('https://api.example.com/premium-data', {
    headers: {
      'X-PAYMENT': paymentHeader
    }
  });

  const data = await paidResponse.json();
  const paymentResponse = paidResponse.headers.get('X-PAYMENT-RESPONSE');

  console.log('支付成功！', JSON.parse(atob(paymentResponse)));
}
```

## 配置选项

### X402ClientOptions

```typescript
interface X402ClientOptions {
  walletClient: WalletClient;        // viem 钱包客户端（必需）
  network?: string;                   // 默认网络（例如，'base-mainnet'）
  preferredToken?: string;            // 首选支付代币地址
  autoRetry?: boolean;                // 自动重试 402（默认：true）
  timeout?: number;                   // 请求超时（毫秒，默认：30000）
}
```

### RequestOptions

```typescript
interface RequestOptions {
  method?: 'GET' | 'POST' | 'PUT' | 'DELETE';
  headers?: Record<string, string>;
  body?: any;                         // 请求正文（自动序列化为 JSON）
  preferredToken?: string;            // 覆盖默认首选代币
}
```

### wrapFetchWithPayment 参数

对于高级用例，`wrapFetchWithPayment` 提供更低级别的控制：

```typescript
function wrapFetchWithPayment(
  fetchFn: typeof fetch,              // 要包装的 Fetch 函数
  signer: Signer | MultiNetworkSigner, // 签名的钱包客户端
  maxPaymentValue: string,             // 最大支付的最小单位（例如，'1000000' 对于 1 USDC）
  selectPaymentRequirements?: Function, // 自定义要求选择器
  config?: {
    timeout?: number;                  // 请求超时（毫秒）
    maxRetries?: number;               // 最大支付重试次数
  },
  paymentPreferences?: {
    preferredToken?: string;           // 要支付的代币地址
    preferredNetwork?: string;         // 网络标识符（例如，'base', 'ethereum'）
  }
): typeof fetch
```

**带有所有参数的示例：**

```typescript
import { wrapFetchWithPayment } from 'anyspend-x402-client';

const fetchWithPayment = wrapFetchWithPayment(
  fetch,
  walletClient,
  '5000000', // 最大 5 USDC
  undefined, // 默认要求选择器
  {
    timeout: 60000,    // 60 秒超时
    maxRetries: 3      // 重试最多 3 次
  },
  {
    preferredToken: '0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb', // DAI
    preferredNetwork: 'base'
  }
);
```

## 支持的代币

x402 客户端可以使用任何支持 **EIP-2612 permit** 或是 **USDC**（使用 EIP-3009 transferWithAuthorization）的代币支付。

常见支持的代币：

- **USDC** - 所有链上的原生支持
- **DAI** - 支持 permit 的稳定币
- **USDT** - 在实现了 permit 的链上

查看 [网络支持](/anyspend/x402-network-support) 以获取每个链上的详细代币地址。

## 示例

### React 组件（使用 X402Client）

```tsx
import { X402Client } from 'anyspend-x402-client';
import { useWalletClient } from 'wagmi';
import { useState } from 'react';

export function PremiumDataFetcher() {
  const { data: walletClient } = useWalletClient();
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(false);

  const fetchPremiumData = async () => {
    if (!walletClient) return;

    setLoading(true);
    try {
      const client = new X402Client({
        walletClient,
        preferredToken: '0x...' // DAI 或其他代币
      });

      const response = await client.request(
        'https://api.example.com/premium-data'
      );

      setData(response.data);
      console.log('使用 TX 支付：', response.paymentResponse?.txHash);
    } catch (error) {
      console.error('支付失败：', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div>
      <button onClick={fetchPremiumData} disabled={loading}>
        {loading ? '支付中...' : '获取高级数据（费用 1 USDC）'}
      </button>
      {data && <pre>{JSON.stringify(data, null, 2)}</pre>}
    </div>
  );
}
```

### React 组件（使用 wrapFetchWithPayment）

对于需要更多控制或使用现有基于 fetch 的代码的应用程序：

```tsx
import { wrapFetchWithPayment } from 'anyspend-x402-client';
import { useWalletClient, useChainId } from 'wagmi';
import { useState } from 'react';

// 从链 ID 获取网络名称的帮助函数
const getNetworkName = (chainId: number): string => {
  const networks: Record<number, string> = {
    8453: 'base',
    1: 'ethereum',
    42161: 'arbitrum',
    10: 'optimism',
    137: 'polygon',
  };
  return networks[chainId] || 'base';
};

export function PremiumDataFetcherAdvanced() {
  const { data: walletClient } = useWalletClient();
  const selectedChain = useChainId();
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(false);
  const [log, setLog] = useState<string[]>([]);

  // 链上的代币地址
  const tokenAddresses: Record<number, string> = {
    8453: '0x50c5725949A6F0c72E6C4a641F24049A917DB0Cb', // Base 上的 DAI
    1: '0x6B175474E89094C44Da98b954EedeAC495271d0F', // Ethereum 上的 DAI
  };

  const fetchPremiumData = async () => {
    if (!walletClient) return;

    setLoading(true);
    setLog([]);

    try {
      const tokenAddress = tokenAddresses[selectedChain];

      const paymentPreferences = {
        preferredToken: tokenAddress,
        preferredNetwork: getNetworkName(selectedChain) as any,
      };

      setLog(prev => [...prev,
        `💡 使用首选代币：${tokenAddress} 在 ${getNetworkName(selectedChain)} 上`
      ]);

      // 用自动支付处理包装 fetch
      const fetchWithPayment = wrapFetchWithPayment(
        fetch,
        walletClient as any,
        '1000000', // 最大 1 USDC
        undefined, // 使用默认支付要求选择器
        undefined, // 使用默认配置
        paymentPreferences,
      );

      setLog(prev => [...prev, '🔄 发起请求...']);

      const response = await fetchWithPayment('https://api.example.com/premium-data');
      const result = await response.json();

      setData(result);
      setLog(prev => [...prev, '✅ 支付成功！']);
    } catch (error) {
      console.error('支付失败：', error);
      setLog(prev => [...prev, `❌ 错误：${error.message}`]);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div>
      <button onClick={fetchPremiumData} disabled={loading}>
        {loading ? '处理支付中...' : '获取高级数据'}
      </button>

      {log.length > 0 && (
        <div style={{ marginTop: '1rem', fontFamily: 'monospace' }}>
          {log.map((entry, i) => <div key={i}>{entry}</div>)}
        </div>
      )}

      {data && <pre>{JSON.stringify(data, null, 2)}</pre>}
    </div>
  );
}
```

### Node.js 脚本

```typescript
import { X402Client } from 'anyspend-x402-client';
import { createWalletClient, http } from 'viem';
import { privateKeyToAccount } from 'viem/accounts';
import { base } from 'viem/chains';

// 从环境中加载私钥
const account = privateKeyToAccount(process.env.PRIVATE_KEY as `0x${string}`);

const walletClient = createWalletClient({
  account,
  chain: base,
  transport: http()
});

const x402Client = new X402Client({
  walletClient,
  preferredToken: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913' // Base 上的 USDC
});

async function main() {
  const response = await x402Client.request(
    'https://api.example.com/ai-inference',
    {
      method: 'POST',
      body: { prompt: '分析这些数据...' }
    }
  );

  console.log('结果：', response.data);
  console.log('支付交易 TX：', response.paymentResponse?.txHash);
}

main();
```

## 错误处理

SDK 为常见的失败场景抛出类型化错误：

```typescript
import { X402Error } from 'anyspend-x402-client';

try {
  const response = await x402Client.request('https://api.example.com/data');
} catch (error) {
  if (error instanceof X402Error) {
    switch (error.code) {
      case 'INSUFFICIENT_BALANCE':
        console.error('钱包中代币不足');
        break;
      case 'SIGNATURE_REJECTED':
        console.error('用户拒绝了签名请求');
        break;
      case 'PAYMENT_EXPIRED':
        console.error('支付截止日期已过，请重试');
        break;
      case 'SETTLEMENT_FAILED':
        console.error('支付验证失败：', error.message);
        break;
      default:
        console.error('支付错误：', error.message);
    }
  }
}
```

## 测试

针对测试资源服务器测试您的集成：

```typescript
const testClient = new X402Client({
  walletClient,
  network: 'base-sepolia', // 使用测试网
  preferredToken: '0x036CbD53842c5426634e7929541eC2318f3dCF7e' // Sepolia 上的 USDC
});

const response = await testClient.request(
  'https://test-api.anyspend.com/echo'
);
```

从 [Coinbase Faucet](https://portal.cdp.coinbase.com/products/faucet) 获取测试网 USDC。

## 最佳实践

<AccordionGroup>
<Accordion title="使用环境变量存储密钥">
永远不要在您的应用程序中
