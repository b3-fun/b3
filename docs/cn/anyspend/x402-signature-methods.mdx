---
title: Permit 与 TransferWithAuthorization 的对比
description: 理解无燃气费支付签名 - EIP-2612 Permit 和 EIP-3009 TransferWithAuthorization
lang: cn
originalPath: anyspend/x402-signature-methods.mdx
---
## 概览

AnySpend x402 使用加密签名而非传统的令牌授权，为用户启用了**无需支付燃气费的支付**。服务商支付所有燃气费，而用户只需签署授权消息。

支持两种主要的签名标准，每种都针对不同的令牌类型进行了优化：

- **EIP-3009 (transferWithAuthorization)** - 由 USDC 使用，一步直接转账
- **EIP-2612 (permit)** - 由 DAI 和大多数现代 ERC-20 令牌使用，两步审批 + 转账

## 快速比较

| 特性 | EIP-2612 (Permit) | EIP-3009 (transferWithAuthorization) |
|---------|-------------------|--------------------------------------|
| **使用者** | DAI, 大多数现代 ERC-20s | USDC (所有网络) |
| **执行** | 两步：批准 + 转账 | 一步：直接转账 |
| **随机数类型** | 顺序（自动增加） | 随机 bytes32 |
| **依赖性** | 必须等待前一个随机数 | 无顺序要求 |
| **理想用途** | 通用 ERC-20 代币 | 稳定币支付 |
| **重放保护** | 顺序随机数 | 随机随机数跟踪 |
| **燃气效率** | 2 交易（permit + transferFrom） | 1 交易（直接转账） |

## EIP-3009: transferWithAuthorization (USDC)

### 概览

直接转账授权 - 签名授权从发送者到接收者的即时转账，无需单独的批准步骤。

**使用者：** 所有网络上的 USDC（Base, Ethereum, Arbitrum, Optimism, Polygon 等）

### 关键优势

- ✅ **一步执行** - 直接转账，无需批准
- ✅ **随机随机数** - 无顺序依赖，可并行交易
- ✅ **即时结算** - 在单一交易中执行
- ✅ **付款方无需燃气费** - 服务商支付燃气费
- ✅ **无前运行** - 随机随机数防止 MEV 攻击

### 消息结构

```solidity
transferWithAuthorization(
    address from,          // 付款人地址
    address to,            // 收款人地址
    uint256 value,         // 转账金额
    uint256 validAfter,    // 0 (立即有效)
    uint256 validBefore,   // 截止时间戳
    bytes32 nonce,         // 随机随机数（防止重放）
    bytes signature        // EIP-712 签名
)
```

### 使用示例

```typescript
import { signTransferWithAuthorization } from 'anyspend-x402-client';

const signature = await signTransferWithAuthorization({
  from: payerAddress,
  to: recipientAddress,
  value: '1000000',              // 1 USDC (6 小数位)
  validBefore: deadline,
  nonce: randomBytes32()         // 生成随机随机数
});
```

### 工作原理

<Steps>
<Step title="用户签署授权">
用户签署一个 EIP-712 消息，使用随机随机数授权转账
</Step>

<Step title="服务商执行转账">
服务商使用签名调用 `receiveWithAuthorization()`
</Step>

<Step title="USDC 转账">
USDC 直接从用户转移到服务商，一次原子交易中
</Step>

<Step title="随机数作废">
标记随机随机数为已使用，防止重放攻击
</Step>
</Steps>

### EIP-712 类型化数据结构

```typescript
const typedData = {
  domain: {
    name: 'USD Coin',
    version: '2',
    chainId: 8453, // Base
    verifyingContract: usdcAddress
  },
  types: {
    TransferWithAuthorization: [
      { name: 'from', type: 'address' },
      { name: 'to', type: 'address' },
      { name: 'value', type: 'uint256' },
      { name: 'validAfter', type: 'uint256' },
      { name: 'validBefore', type: 'uint256' },
      { name: 'nonce', type: 'bytes32' }
    ]
  },
  message: {
    from: payerAddress,
    to: recipientAddress,
    value: '1000000',
    validAfter: 0,
    validBefore: deadline,
    nonce: randomNonce
  }
};
```

---

## EIP-2612: Permit (标准 ERC-20)

### 概览

基于签名的批准，设置一个额度，随后进行单独的 `transferFrom()` 调用。这是大多数现代 ERC-20 代币的标准方法。

**使用者：** DAI 和大多数支持 permit 的现代 ERC-20 代币

### 关键优势

- ✅ **广泛采用** - 许多代币的标准
- ✅ **限时批准** - 基于截止时间的过期
- ✅ **ERC-20 兼容** - 与现有基础设施兼容
- ✅ **付款方无需燃气费** - 服务商支付燃气费
- ✅ **生态系统支持** - 由主要钱包和 dapps 支持

### 消息结构

```solidity
permit(
    address owner,         // 代币拥有者
    address spender,       // 获批准的花费者（服务商）
    uint256 value,         // 批准金额
    uint256 deadline,      // 过期时间戳
    uint8 v, bytes32 r, bytes32 s  // 签名组件
)
```

### 使用示例

```typescript
import { signPermit } from 'anyspend-x402-client';

const nonce = await token.nonces(ownerAddress);  // 获取当前随机数

const signature = await signPermit({
  token: tokenAddress,
  owner: ownerAddress,
  spender: facilitatorAddress,
  value: '1000000000000000000',  // 1 DAI (18 小数位)
  deadline: deadline,
  nonce: nonce                    // 顺序随机数
});
```

### 工作原理

<Steps>
<Step title="用户签署 Permit">
用户使用当前顺序随机数签署一个 EIP-712 permit 消息
</Step>

<Step title="服务商调用 Permit">
服务商调用 `permit()` 在链上设置额度
</Step>

<Step title="随机数自动增加">
代币合约自动增加用户的随机数
</Step>

<Step title="服务商转移代币">
服务商调用 `transferFrom()` 使用批准转移代币
</Step>
</Steps>

### EIP-712 类型化数据结构

```typescript
const typedData = {
  domain: {
    name: 'Dai Stablecoin',
    version: '1',
    chainId: 8453, // Base
    verifyingContract: daiAddress
  },
  types: {
    Permit: [
      { name: 'owner', type: 'address' },
      { name: 'spender', type: 'address' },
      { name: 'value', type: 'uint256' },
      { name: 'nonce', type: 'uint256' },
      { name: 'deadline', type: 'uint256' }
    ]
  },
  message: {
    owner: ownerAddress,
    spender: facilitatorAddress,
    value: '1000000000000000000',
    nonce: currentNonce,
    deadline: deadline
  }
};
```

---

## 我的代币使用哪种方法？

### 检查代币支持

```typescript
// 检查代币是否支持 EIP-3009 (USDC 风格)
const hasTransferWithAuth = await token.read.transferWithAuthorization !== undefined;

// 检查代币是否支持 EIP-2612 (标准 permit)
const hasPermit = await token.read.permit !== undefined;
const hasDomainSeparator = await token.read.DOMAIN_SEPARATOR !== undefined;
```

### 按方法常见的代币

**EIP-3009 (transferWithAuthorization):**
- USDC (所有链)
- USDC.e (桥接版本)

**EIP-2612 (permit):**
- DAI (所有链)
- 大多数现代 ERC-20s
- USDT (在某些链上 - Base, Arbitrum, Optimism)
- 许多 DeFi 代币

**无无燃气费支持:**
- 以太坊主网上的 USDT (无 permit)
- Polygon 上的 USDT (无 permit)
- 旧 ERC-20 代币

<Note>
AnySpend x402 客户端会根据代币合约自动检测使用哪种签名方法。您无需手动指定。
</Note>

## 随机数管理

### 随机随机数 (EIP-3009)

**优势:**
- 无顺序依赖 - 多个签名可以以任何顺序使用
- 可能的并行交易
- 如果一笔交易失败，不会阻塞状态

**实现:**
```typescript
import { randomBytes } from 'crypto';

// 生成加密安全的随机随机数
const nonce = '0x' + randomBytes(32).toString('hex');
```

**随机数跟踪:**
```solidity
// 检查随机数是否已使用
mapping(address => mapping(bytes32 => bool)) public authorizationState;

function isAuthorizationUsed(address authorizer, bytes32 nonce)
    external
    view
    returns (bool)
{
    return authorizationState[authorizer][nonce];
}
```

### 顺序随机数 (EIP-2612)

**优势:**
- 简单且可预测
- 燃气效率高（单个存储槽）
- 所有 permit 实现中的标准

**实现:**
```typescript
// 从代币合约获取当前随机数
const currentNonce = await token.read.nonces([ownerAddress]);

// 使用当前随机数签署
const signature = await signPermit({
  // ...
  nonce: currentNonce
});
```

**随机数自动增加:**
```solidity
// 代币合约自动增加
mapping(address => uint256) public nonces;

function permit(/* ... */) external {
    require(nonce == nonces[owner], "Invalid nonce");
    nonces[owner]++; // 自动增加
    // ... 其余 permit 逻辑
}
```

## 安全考虑

### 重放保护

**EIP-3009:**
- 随机随机数防止跨链和合约的重放
- 每个随机数只能每个地址使用一次
- 随机数状态在链上以映射存储

**EIP-2612:**
- 顺序随机数防止重放
- 必须使用当前随机数（自动增加）
- 失败的交易阻塞后续签名，直到重新签名

### 截止时间执行

两种方法都执行截止时间以防止陈旧签名：

```typescript
const deadline = Math.floor(Date.now() / 1000) + 300; // 从现在起 5 分钟
```

**最佳实践:**
- 使用短截止时间（5-10 分钟）以确保安全
- 如有需要，使用较长截止时间（30-60 分钟）以获得更好的用户体验
- 永远不要使用 `type(uint256).max` 进行无限批准

### 签名验证

两种方法都使用 EIP-712 验证签名：

```typescript
// 从签名中恢复签名者
const recoveredAddress = recoverTypedDataAddress({
  domain,
  types,
  primaryType,
  message,
  signature
});

// 验证签名者与预期地址匹配
if (recoveredAddress !== expectedSigner) {
  throw new Error('Invalid signature');
}
```

## 客户端 SDK 集成

AnySpend x402 客户端自动处理所有签名复杂性：

```typescript
import { X402Client } from 'anyspend-x402-client';

const client = new X402Client({
  walletClient,
  preferredToken: tokenAddress // USDC 或 DAI
});

// 客户端自动：
// 1. 检测代币是否使用 permit 或 transferWithAuthorization
// 2. 获取当前随机数（对于 permit）或生成随机随机数
// 3. 构造正确的 EIP-712 类型化数据
// 4. 提示用户签名
// 5. 在 X-PAYMENT 头中包含签名

const response = await client.request('https://api.example.com/data');
```

## 燃气费用比较

| 方法 | 用户燃气 | 服务商燃气 | 总交易数 |
|--------|----------|-----------------|-------------------|
| EIP-3009 | 0 | 约 45,000 | 1 |
| EIP-2612 | 0 | 约 70,000 (permit) + 约 45,000 (transfer) | 2 |

<Note>
所有燃气费用由服务商支付，并包含在 0.25% 的 AnySpend 费用中。用户从不直接支付燃气费。
</Note>

## 进一步阅读

<CardGroup cols={2}>
<Card title="EIP-2612 规范" icon="file-lines" href="https://eips.ethereum.org/EIPS/eip-2612">
  官方 EIP-2612 permit 规范
</Card>

<Card title="EIP-3009 规范" icon="file-lines" href="https://eips.ethereum.org/EIPS/eip-3009">
  官方 EIP-3009 transferWithAuthorization 规范
</Card>

<Card title="EIP-712 类型化数据" icon="signature" href="https://eips.ethereum.org/EIPS/eip-712">
  EIP-712 类型化结构数据哈希和签名
</Card>

<Card title="网络支持" icon="globe" href="/anyspend/x402-network-support">
  查看每个网络上支持哪些方法的代币
</Card>
</CardGroup>
