---
title: 백엔드 통합
description: '백엔드에서 베팅 처리, 게임 로직, 그리고 지급 처리를 다루기 위해 B3 클라이언트를 초기화하세요.'
lang: ko
originalPath: upside/backend-integration.mdx
---
## createB3Client

Upside의 API와 상호작용하기 위해 백엔드에서 B3 클라이언트를 초기화합니다.

**프레임워크 지원**: 현재 **Hono**와 **Cloudflare Workers**를 지원합니다.

```javascript
import { createB3Client } from "@b3dotfun/upside-sdk/server";

// Hono 라우트 핸들러에서
app.post("/api/game/play", async c => {
  // Hono 컨텍스트에서 B3Client 생성
  // Authorization 헤더에서 자동으로 인증 토큰 추출
  const b3Client = createB3Client(c);

  // 이제 게임 작업을 위해 b3Client 사용
  const betResult = await b3Client.placeBet("coin-flip", "1000000000000000000");

  return c.json({ success: true, sessionId: betResult.sessionId });
});
```

**파라미터:**

- `context` (Hono Context): 다음을 포함하는 Hono 컨텍스트 객체:
  - `req.header(name: string)`: 요청 헤더 추출 메소드
  - `env` (선택사항): Cloudflare Workers 환경

**반환값:**

- Authorization 헤더에서 자동으로 인증이 구성된 B3Client 인스턴스

**인증:** 인증 헤더는 들어오는 요청에서 자동으로 추출됩니다:

```
Authorization: Bearer {player_token}
```

## 핵심 기능

### placeBet

베팅을 하여 게임 세션을 시작합니다. 이는 베팅 금액을 확정하고 게임 세션을 생성합니다.

```javascript
const betResult = await b3Client.placeBet(
  gameType, // string: "coin-flip", "dice" 등.
  betAmount, // string: wei 단위의 베팅 금액 (예: "100000000000000000" = 1 토큰)
);

// 응답:
// {
//   sessionId: "session_abc123",
//   gameId: "game_xyz789",
//   status: "active",
//   createdAt: "2024-01-15T10:30:00Z"
// }
```

**파라미터:**

- `gameType` (string): 게임의 식별자 (예: "coin-flip", "dice-roll")
- `betAmount` (string): wei 단위의 베팅 금액 (1 토큰 = 10^18 wei, 예: "100000000000000000")

**반환값:**

- `sessionId`: 이 게임 세션의 고유 식별자
- `gameId`: 게임 기록 식별자
- `status`: 현재 세션 상태 ("active", "completed", "failed")
- `createdAt`: 베팅 생성의 ISO 타임스탬프

**오류:**

- 플레이어 잔액 부족
- 잘못된 게임 타입
- 게임이 활성화/사용 가능하지 않음
- 잘못된 베팅 금액

### processPayout

게임을 완료하고 플레이어의 당첨금을 지급합니다.

```javascript
const payoutResult = await b3Client.processPayout(
  gameType, // string: "coin-flip" 등.
  sessionId, // string: placeBet 응답에서
  payoutAmount, // string: wei 단위로 지급할 WIN (패배시 0)
  {
    playerChoice: "heads", // 플레이어가 선택/예측한 것
    result: "heads", // 실제 게임 결과
    outcome: "win", // "win" 또는 "loss"
  },
);

// 응답:
// {
//   status: "completed",
//   payoutAmount: "150000000000000000",
//   newBalance: "1350000000000000000",
//   updatedAt: "2024-01-15T10:30:30Z"
// }
```

**파라미터:**

- `gameType` (string): placeBet에서의 같은 게임 타입
- `sessionId` (string): placeBet 응답에서의 세션 ID
- `payoutAmount` (string): wei 단위로 지급할 WIN 토큰 (패배시 0, 예: "150000000000000000" = 1.5 토큰)
- `metadata` (object):
  - `playerChoice`: 플레이어가 선택/예측한 것
  - `result`: 실제 게임 결과
  - `outcome`: "win" 또는 "loss"

**반환값:**

- `status`: "completed", "failed" 등.
- `payoutAmount`: wei 단위로 지급된 금액
- `newBalance`: 플레이어의 업데이트된 WIN 잔액(wei 단위)
- `updatedAt`: 완료의 ISO 타임스탬프

**오류:**

- 세션을 찾을 수 없음
- 세션이 이미 완료됨 (중복 요청)
- 지급액이 풀 한도를 초과함
- 베팅 금액 형식이 잘못됨

## 백엔드 예제

```javascript
import { Hono } from "hono";
import { createB3Client } from "@b3dotfun/upside-sdk/server";

const app = new Hono();

app.post("/api/game/coin-flip", async c => {
  const { prediction, betAmount } = await c.req.json();

  try {
    // Hono 컨텍스트에서 B3Client 생성
    // Authorization 헤더에서 자동으로 인증 토큰 추출
    const b3Client = createB3Client(c);

    // 단계 1: 베팅하기 (wei 단위로 금액)
    const betResult = await b3Client.placeBet("coin-flip", betAmount);

    if (!betResult.sessionId) {
      return c.json({ error: "베팅 실패" }, 400);
    }

    // 단계 2: 게임 로직 - 동전 던지기
    const coin = Math.random() < 0.5 ? "heads" : "tails";
    const isWin = coin === prediction;
    // 지급 계산: 승리시 50% 이익 (베팅 금액 * 1.5, wei 단위)
    const payout = isWin ? (BigInt(betAmount) * BigInt(150)) / BigInt(100) : "0";

    // 단계 3: 데이터베이스에 게임 저장 (D1 등)
    // await db.execute(
    //   "INSERT INTO games (sessionId, prediction, result, betAmount, payout) VALUES (?, ?, ?, ?, ?)",
    //   [betResult.sessionId, prediction, coin, betAmount, payout.toString()]
    // );

    // 단계 4: 지급 처리
    const payoutResult = await b3Client.processPayout("coin-flip", betResult.sessionId, payout.toString(), {
      playerChoice: prediction,
      result: coin,
      outcome: isWin ? "win" : "loss",
    });

    // 단계 5: 프론트엔드에 결과 반환
    return c.json({
      sessionId: betResult.sessionId,
      prediction,
      result: coin,
      outcome: isWin ? "win" : "loss",
      payout: isWin ? payout.toString() : "0",
      newBalance: payoutResult.newBalance,
    });
  } catch (error) {
    console.error("게임 오류:", error);
    return c.json({ error: error.message }, 500);
  }
});

export default app;
```

**Express와의 주요 차이점:**

- `createB3Client(c)`는 Hono 컨텍스트에서 자동으로 인증을 추출합니다
- Cloudflare Workers (서버리스)에서 실행됩니다
- 수동 미들웨어가 필요 없습니다 - Hono 컨텍스트가 모든 것을 처리합니다
- 응답은 `c.json()`을 사용합니다, `res.json()`이 아닙니다

**환경 설정 (wrangler.toml):**

```toml
[env.production]
name = "upside-games"
route = "example.com/api/*"
zone_id = "..."
account_id = "..."

[[env.production.env.vars]]
# 여기에 환경 변수를 추가하세요
```

## 모범 사례

### 베팅 배치

- **금액을 항상 검증하세요**: 베팅이 플레이어 잔액 내에 있는지 확인하세요
- **멱등성 사용**: 같은 sessionId로 실패한 `placeBet` 호출을 재시도하세요
- **즉시 잠금**: `placeBet`이 성공하면 플레이어가 다른 베팅을 할 수 없도록 방지하세요

### 게임 로직

- **백엔드가 진실의 원천**: 클라이언트 측 게임 결과를 절대 신뢰하지 마세요
- **모든 것을 저장하세요**: 감사와 분쟁을 위해 모든 게임 이벤트를 기록하세요
- **결과를 검증하세요**: 게임 결과가 예상 범위와 일치하는지 확인하세요
- **게임 시간 초과**: 지급이 처리되지 않으면 5분 내에 베팅을 취소하세요

### 지급 처리

- **한 번만 처리하세요**: 게임 세션 당 `processPayout`을 한 번만 호출하세요
- **정확한 금액을 사용하세요**: 지급 계산을 보내기 전에 확인하세요
- **중복 처리**: `processPayout`이 "이미 완료됨"을 반환하면 괜찮습니다
- **실패 처리**: 실패한 지급을 재시도하세요, 하지만 먼저 이미 지급되었는지 확인하세요

### 보안

- **토큰 검증**: 모든 백엔드 요청에서 JWT를 항상 검증하세요
- **HTTPS 사용**: 모든 통신은 암호화되어야 합니다
- **게임 타입 검증**: 알려진, 승인된 게임 타입만 허용하세요
- **속도 제한**: 남용을 방지하기 위해 속도 제한을 구현하세요

### 오류 처리

```javascript
async function safePlayGame(gameType, betAmount) {
  try {
    // 베팅하기
    let betResult;
    try {
      betResult = await b3Client.placeBet(gameType, betAmount);
    } catch (error) {
      if (error.message.includes("잔액 부족")) {
        return { error: "플레이어 잔액이 낮습니다" };
      }
      throw error;
    }

    // 게임 로직 실행
    const outcome = await runGameLogic();

    // 지급 처리
    try {
      const payout = outcome.isWin ? betAmount * 1.5 : "0";
      await b3Client.processPayout(gameType, betResult.sessionId, payout, {
        playerChoice: outcome.choice,
        result: outcome.result,
        outcome: outcome.isWin ? "win" : "loss",
      });
    } catch (error) {
      if (error.message.includes("이미 완료됨")) {
        console.log("세션에 대한 지급이 이미 처리되었습니다");
      } else {
        throw error;
      }
    }

    return outcome;
  } catch (error) {
    console.error("게임 오류:", error);
    throw error;
  }
}
```
